<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>WELCOME MINI MYID PLUS (ALPHA)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsencrypt/3.3.2/jsencrypt.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}
        input,textarea{-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text}
        .container{background:linear-gradient(135deg,#e9ecef 0%,#ffffff 100%) !important;box-shadow:inset 0 0 50px rgba(255,255,255,.6),0 20px 40px rgba(0,0,0,.05) !important;width:100% !important;height:100vh !important;padding:20px !important;margin:0 !important;border-radius:0 !important;position:relative !important;overflow:auto !important;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
        .container:hover{transform:none !important}
        
        /* Watermark Styles */
        .watermark {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            color: rgba(0, 0, 0, 0.3);
            font-size: 12px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        .watermark .channel {
            font-weight: bold;
            margin-bottom: 2px;
        }
        .watermark .developer {
            font-size: 11px;
        }

        /* Watermark version styling */
        .watermark .version {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        h1{color:#333;margin-bottom:10px;font-weight:600}
        .subtitle{color:#666;margin-bottom:30px;font-size:16px}
        .input-group{margin-bottom:25px;text-align:left}
        label{display:block;margin-bottom:8px;color:#555;font-weight:500}
        .input-container{position:relative;display:flex;align-items:center}
        .token-input{width:100%;padding:15px 15px 15px 45px;border:2px solid #e1e5ee;border-radius:10px;font-size:16px;transition:all .3s;outline:none}
        .token-input:focus{border-color:#4CAF50;box-shadow:0 0 0 3px rgba(37,117,252,.1)}
        .input-icon{position:absolute;left:15px;color:#4CAF50;font-size:18px}
        .container div{border-left:none !important}
        .toggle-visibility{position:absolute;right:15px;background:none;border:none;color:#666;cursor:pointer;font-size:18px}
        .btn{background:linear-gradient(to right,#4CAF50,#4CAF50);color:#fff;border:none;border-radius:10px;padding:15px 30px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;width:100%;display:flex;justify-content:center;align-items:center;gap:10px;position:relative;height:50px;min-height:50px}
        .btn .btn-text{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);margin:0;white-space:nowrap}
        .message{margin-top:20px;padding:12px;border-radius:8px;font-size:14px;display:none}
        .success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
        .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;margin-bottom:5px;}
        .info{margin-top:20px;font-size:14px;color:#666;text-align:left;background:#f8f9fa;padding:15px;border-radius:8px;border-left:4px solid #4CAF50}
        .login-tabs{display:flex;margin-bottom:25px;border-radius:10px;background:#f8f9fa;padding:5px}
        .tab-btn{flex:1;padding:12px;border:none;background:transparent;border-radius:8px;cursor:pointer;font-weight:500;transition:all .3s;color:#666}
        .tab-btn.active{background:#fff;color:#4CAF50;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .otp-timer{text-align:center;margin:10px 0;font-size:14px;color:#666}
        .otp-timer.expiring{color:#4CAF50;font-weight:600}
        .resend-otp{background:none;border:none;color:#4CAF50;cursor:pointer;font-size:14px;text-decoration:underline;margin-top:10px}
        .resend-otp:disabled{color:#999;cursor:not-allowed}
        .spinner{display:none;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading .spinner{display:inline-block}
        .loading .btn-text{display:none}
        .data-screen{display:none}
        .account-card{background:#fff;border-radius:15px;box-shadow:0 3px 10px rgba(0,0,0,.1);padding:15px;margin-bottom:8px;text-align:left;border-left:5px solid #4CAF50}
        .account-card{margin-bottom:8px !important}
        .member-card{margin-bottom:8px !important}
        .button-group{margin-top:8px !important;gap:12px !important}
        .account-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee}
        .header-left{display:flex;align-items:center;gap:8px}
        .msisdn{font-weight:600;color:#333;font-size:18px}
        .mytel-badge{background:#4CAF50;color:#fff;padding:5px 10px;border-radius:20px;font-size:12px;font-weight:600;border:none;display:inline-flex;align-items:center;gap:6px;cursor:pointer}
        
        .balance-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin:0}
        .balance-item{background:#f8f9fa;padding:15px;border-radius:10px;text-align:center;width:100%}
        .balance-name{font-size:14px;color:#666;margin-bottom:5px}
        .balance-amount{font-size:18px;font-weight:700;color:#4CAF50}
        .balance-unit{font-size:14px;color:#888}
        
        .button-group{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-top:25px}
        .play-btn,.history-btn,.exchange-btn,.prize-history-btn{background:#fff;color:#000;border:none;border-radius:16px;padding:16px 0;font-size:13px;font-weight:600;cursor:pointer;width:100%;height:80px;box-shadow:0 2px 7px rgba(0,0,0,.1);transition:all .3s ease}
        .play-btn:hover,.history-btn:hover,.exchange-btn:hover,.prize-history-btn:hover{transform:translateY(-2px);box-shadow:0 2px 7px rgba(0,0,0,.15)}
        
        /* Switch Account Modal */
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center}
        .modal-overlay.active{display:flex}
        .modal-content{background:#fff;border-radius:20px;padding:25px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #f0f0f0;padding-bottom:15px}
        .modal-title{font-size:20px;font-weight:700;color:#333}
        .modal-close{background:none;border:none;font-size:28px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
        .modal-close:hover{color:#333}
        .saved-account-item{background:#f8f9fa;border-radius:12px;padding:15px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border-left:4px solid #4CAF50}
        .saved-account-item.current-account{border-left-color:#FFB900;background:#fffbf0}
        .saved-account-info{flex:1}
        .saved-account-phone{font-weight:600;font-size:16px;color:#333;margin-bottom:5px}
        .saved-account-date{font-size:12px;color:#999}
        .current-badge{display:inline-block;background:#FFB900;color:#fff;font-size:10px;padding:3px 8px;border-radius:10px;margin-left:8px;font-weight:700}
        .saved-account-actions{display:flex;gap:8px}
        .account-action-btn{padding:8px 15px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .3s}
        .switch-account-btn{background:#4CAF50;color:#fff}
        .switch-account-btn:hover{background:#45a049}
        .delete-account-btn{background:#ff4444;color:#fff}
        .delete-account-btn:hover{background:#cc0000}
        .no-accounts-msg{text-align:center;padding:40px 20px;color:#999;font-size:15px}
        .add-current-account-btn{width:100%;padding:12px;background:#4CAF50;color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;margin-top:15px}
        .add-current-account-btn:hover{background:#45a049}
        .back-btn{background:#f8f9fa;color:#666;border:1px solid #ddd;border-radius:10px;padding:10px 20px;font-size:14px;cursor:pointer;margin-top:10px;transition:all .3s}
        .back-btn:hover{background:#e9ecef}
        
        /* Prize History Modal */
        .prize-history-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;justify-content:center;align-items:center}
        .prize-history-overlay.active{display:flex}
        .prize-history-content{background:#fff;border-radius:20px;padding:25px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
        .prize-history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:2px solid #f0f0f0;padding-bottom:15px}
        .prize-history-title{font-size:20px;font-weight:700;color:#333}
        .prize-history-close{background:none;border:none;font-size:28px;color:#999;cursor:pointer;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center}
        .prize-history-close:hover{color:#333}
        .prize-history-item{background:#f8f9fa;border-radius:12px;padding:15px;margin-bottom:12px;display:flex;align-items:center;gap:15px;border-left:4px solid #4CAF50;transition:all .3s}
        .prize-history-item:hover{transform:translateX(5px);box-shadow:0 3px 10px rgba(0,0,0,0.1)}
        .prize-history-icon{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
        .prize-history-details{flex:1}
        .prize-history-name{font-weight:600;font-size:16px;color:#333;margin-bottom:3px}
        .prize-history-date{font-size:12px;color:#999}
        .prize-history-amount{font-size:18px;font-weight:700;color:#4CAF50}
        .no-prize-msg{text-align:center;padding:40px 20px;color:#999;font-size:15px}
        .no-prize-icon{font-size:48px;margin-bottom:15px;opacity:0.3}
        .clear-history-btn{width:100%;padding:12px;background:#ff4444;color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;margin-top:15px;transition:all .3s}
        .clear-history-btn:hover{background:#cc0000}
        .prize-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;padding:15px;background:#f8f9fa;border-radius:12px}
        .prize-stat-item{text-align:center}
        .prize-stat-value{font-size:20px;font-weight:700;color:#4CAF50;margin-bottom:3px}
        .prize-stat-label{font-size:11px;color:#666;text-transform:uppercase}
        /* Icon used in prize statistics. Sized smaller and centered above the value. */
        .prize-stat-icon{
            width:32px;
            height:32px;
            margin:0 auto 6px;
            display:block;
        }
        
        /* Prize Dialog Modal */
        .prize-dialog-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10000;justify-content:center;align-items:center;animation:fadeIn 0.3s ease}
        .prize-dialog-overlay.active{display:flex}
        .prize-dialog-content{background:linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);border-radius:30px;padding:40px 30px;width:90%;max-width:450px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.6);animation:slideUp 0.4s ease;position:relative}
        .prize-dialog-close{position:absolute;top:15px;right:15px;background:rgba(0,0,0,0.1);border:none;width:38px;height:38px;border-radius:50%;font-size:22px;color:#666;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s;font-weight:700}
        .prize-dialog-close:hover{background:rgba(0,0,0,0.2);color:#333;transform:rotate(90deg)}
        .prize-dialog-title{font-size:32px;font-weight:800;color:#4CAF50;margin-bottom:10px;text-transform:uppercase;letter-spacing:2px;text-shadow:2px 2px 4px rgba(0,0,0,0.1)}
        .prize-dialog-subtitle{font-size:18px;color:#666;margin-bottom:25px;font-weight:500}
        .prize-dialog-image{width:100%;max-width:200px;height:200px;object-fit:contain;margin:20px auto;filter:drop-shadow(0 8px 25px rgba(76,175,80,0.3));animation:prizeFloat 2s ease-in-out infinite}
        .prize-dialog-name{font-size:28px;font-weight:700;color:#333;margin:20px 0 10px 0;text-transform:uppercase}
        .prize-dialog-description{font-size:15px;color:#555;margin-bottom:25px;line-height:1.8;font-weight:500;white-space:pre-line}
        .prize-dialog-ok-btn{background:linear-gradient(135deg, #4CAF50 0%, #45a049 100%);color:#fff;border:none;border-radius:15px;padding:16px 50px;font-size:18px;font-weight:700;cursor:pointer;transition:all .3s;box-shadow:0 6px 20px rgba(76,175,80,0.4);text-transform:uppercase;letter-spacing:1px}
        .prize-dialog-ok-btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(76,175,80,0.5)}
        .prize-dialog-ok-btn:active{transform:translateY(-1px)}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideUp{from{transform:translateY(60px) scale(0.9);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
        @keyframes prizeFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .play-screen{display:none}
        .play-screen-ready .init-section{display:none !important}
        .status-display{background:#f8f9fa;border-radius:10px;padding:15px;margin:20px 0;text-align:left;border-left:4px solid #4CAF50}
        .status-label{font-size:14px;color:#666;margin-bottom:5px}
        .status-value{font-size:16px;font-weight:600}
        .status-ready{color:#4CAF50}
        .status-loading{color:#4CAF50}
        .status-error{color:#4CAF50}
        .phone-input{width:100%;padding:15px;border:2px solid #e1e5ee;border-radius:10px;font-size:16px;margin-bottom:0px;transition:all .3s;outline:none}
        .phone-input:focus{border-color:#4CAF50;box-shadow:0 0 0 3px rgba(214,51,132,.1)}
        .player-info{background:#fff;border-radius:15px;box-shadow:0 2px 7px rgba(0,0,0,.1);padding:15px;margin:15px 0;text-align:left;border-left:5px solid #4CAF50;max-height:225px;overflow:hidden}
        .player-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee}
        .player-msisdn{font-weight:600;color:#333;font-size:18px}
        .player-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
        .player-header .back-compact{background:#fff;color:#000;border:none;border-radius:30px;padding:8px 14px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.08);cursor:pointer;display:flex;align-items:center;gap:8px}
        .stat-item{background:#f8f9fa;padding:15px;border-radius:10px;text-align:center;width:100%}
        .stat-name{font-size:14px;color:#666;margin-bottom:5px}
        .stat-value{font-size:18px;font-weight:700;color:#4CAF50}
        .button-container{
          display:grid !important;
          grid-template-columns:repeat(2,minmax(0,1fr)) !important;
          align-items:stretch !important;
          gap:12px !important;
          background:#fff !important;
          border-radius:15px !important;
          box-shadow:0 2px 5px rgba(0,0,0,.1) !important;
          padding:15px !important;
          margin-bottom:8px !important;
          text-align:center !important;
          border-left:none !important;
        }
        .button-container::before{border:none !important;}
        #heartToDia,
        #diaToTurn{
          width:100% !important;
          min-width:0 !important;
          height:90px !important;
          display:flex !important;
          flex-direction:column !important;
          align-items:center !important;
          justify-content:center !important;
          gap:8px !important;
          text-align:center !important;
          background:#f2f2f2 !important;
          border-radius:12px !important;
          box-shadow:none !important;
          color:#777 !important;
        }
        #heartToDia .btn-icon,
        #diaToTurn .btn-icon{
          font-size:24px !important;
          color:#aaa !important;
          transition:all .3s ease !important;
        }
        #startAutoBtn{
          grid-column:1 / -1 !important;
          width:100% !important;
          min-width:0 !important;
          margin-top:-10px !important;
          margin-bottom:1px !important;
          display:inline-flex !important;
          align-items:center !important;
          justify-content:center !important;
          height:50px !important;
          gap:6px !important;
          text-align:center !important;
          background:#f2f2f2 !important;
          color:#555 !important;
          border:none !important;
          border-radius:12px !important;
          transition:all .25s ease !important;
        }
        #startAutoBtn.success{
          background:linear-gradient(to right,#4CAF50,#3bd27f) !important;
          color:#fff !important;
          box-shadow:0 3px 10px rgba(56,183,73,.25) !important;
        }
        #startAutoBtn.success:hover{
          transform:translateY(-2px);
          box-shadow:0 4px 12px rgba(56,183,73,.35) !important;
        }
        #heartToDia.success .btn-icon{color:#4CAF50 !important;}
        #diaToTurn.success .btn-icon{color:#4CAF50 !important;}
        #heartToDia.success,
        #diaToTurn.success{color:#111 !important;}
        #heartToDia .btn-text,
        #diaToTurn .btn-text,
        #startAutoBtn .btn-text{
          display:block !important;
          line-height:1.3 !important;
          font-size:14px !important;
        }
        .game-btn{background:rgba(255,255,255,.9);color:#333;border:none;border-radius:12px;padding:16px 20px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;justify-content:flex-start;gap:15px;box-shadow:0 2px 8px rgba(0,0,0,.1);position:relative;overflow:hidden;width:100%;margin-bottom:12px}
        .game-btn:hover{transform:translateY(-2px);box-shadow:0 2px 8px rgba(0,0,0,.15);background:rgba(255,255,255,.95)}
        .game-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);transition:.5s}
        .game-btn:hover::before{left:100%}
        .btn-icon{font-size:20px;width:30px;text-align:center}
        .btn-text{display:flex;flex-direction:column;align-items:flex-start;line-height:1.3;flex:1}
        .btn-main-text{font-size:16px;font-weight:700;color:#333}
        .btn-sub-text{font-size:13px;font-weight:500;color:#666}
        .htd-btn .btn-icon{color:#4CAF50}
        .dtt-btn .btn-icon{color:#4CAF50}
        .back-btn .btn-icon{color:#a8a8a8}
        .auto-btn .btn-icon{color:#ffd93d}
        .auto-btn{border-radius:35px;height:50px;min-height:50px;padding:0 20px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.9);color:#333;border:none;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;box-shadow:0 4px 15px rgba(0,0,0,.1);position:relative;overflow:hidden;width:100%;margin-bottom:12px;box-sizing:border-box;gap:10px;text-align:center}
        .auto-btn .btn-text{display:flex;flex-direction:column;align-items:center;justify-content:center;line-height:1.3}
        .auto-btn .btn-icon{font-size:20px;text-align:center}
        .game-btn:disabled{background:rgba(255,255,255,.6);color:#999;cursor:not-allowed;transform:none;box-shadow:0 2px 8px rgba(0,0,0,.1)}
        .game-btn:disabled::before{display:none}
        .stats-display{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;display:none}
        .stat-card {
          background: #fff;
          border-radius: 15px;
          box-shadow:0 2px 6px rgba(0,0,0,.1);
          padding:12px 14px !important;
          border-left:4px solid #4CAF50;
          display:flex !important;
          flex-direction:row !important;
          align-items:center !important;
          justify-content:center !important;
          gap:10px !important;
          width:auto !important;
          height:45px !important;
          margin-top:4px !important;
          margin-bottom:4px !important;
        }

        .stat-icon {
          font-size:15px !important;
          margin-bottom:0 !important;
          flex-shrink:0 !important;
          width:18px !important;
          text-align:center !important;
        }

        .stat-data .stat-icon { color:#4CAF50; }
        .stat-point .stat-icon { color:#4CAF50; }
        .stat-voice .stat-icon { color:#4CAF50; }

        .stat-content {
          display:flex !important;
          flex-direction:row !important;
          align-items:baseline !important;
          justify-content:center !important;
          text-align:center !important;
          gap:4px !important;
          height:100% !important;
        }

        .stat-label {
          font-size:11px !important;
          color:#666;
          margin-bottom:0 !important;
          line-height:1.2 !important;
          display:inline-block !important;
        }

        .stat-value {
          font-size:16px !important;
          font-weight:700;
          line-height:1.2 !important;
          margin-bottom:0 !important;
          display:inline-block !important;
        }

        .stat-data .stat-value { color:#4CAF50; }
        .stat-point .stat-value { color:#4CAF50; }
        .stat-voice .stat-value { color:#4CAF50; }

        .stat-unit {
          font-size:12px;
          color:#888;
          margin-left:2px;
          line-height:1.2;
        }
        .game-log {
          position:relative;
          border-radius:18px;
          padding:20px 16px 32px 16px !important;
          margin:25px 0;
          text-align:left;
          max-height:400px;
          min-height:250px;
          height:350px;
          overflow-y:auto;
          display:flex;
          flex-direction:column;
          background:rgba(255,255,255,.15);
          backdrop-filter:blur(20px);
          -webkit-backdrop-filter:blur(20px);
          overflow:hidden;
        }

        .game-log::before {
          content:"";
          position:absolute;
          top:0;
          left:0;
          right:0;
          bottom:0px;
          border-radius:18px;
          border:1px solid rgba(244,143,177,1);
          pointer-events:none;
        }

        .log-header {
          display:flex;
          justify-content:space-between;
          align-items:center;
          margin-bottom:16px !important;
        }

        .log-title {
          font-weight:600;
          color:#333;
        }

        .log-clear {
          background:transparent;
          color:#000;
          border:2px solid #4CAF50;
          border-radius:20px;
          padding:6px 15px;
          font-size:12px;
          font-weight:600;
          cursor:pointer;
          transition:all .3s ease;
        }

        .log-clear:hover {
          transform:translateY(-1px);
          border:2px solid #34ce57;
        }

        .log-content {
          font-family:monospace;
          font-size:13px;
          line-height:1.5;
          max-height:320px;
          height:320px;
          overflow-y:scroll;
          flex-grow:1;
          scroll-behavior:smooth;
          padding-top:8px !important;
          padding-bottom:50px !important;
          scrollbar-width:none;
        }

        .log-content::-webkit-scrollbar {
          display:none;
        }

        .log-content p:last-child {
          margin-bottom:10px !important;
        }
        .log-item{margin-bottom:5px}
        .log-success{color:#4CAF50}
        .log-error{color:#4CAF50}
        .log-info{color:#4CAF50}
        #tokenScreen,#dataScreen,#playScreen,#historyScreen .account-card{background:transparent;box-shadow:none;border:none;padding:0}
        #historyScreen .history-top{display:flex;align-items:center;gap:10px;margin:6px 0 12px 0;padding:0;border:none}
        #historyScreen .back-compact{background:#fff;color:#000;border:none;border-radius:30px;padding:8px 14px;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,.08);cursor:pointer}
        #historyScreen .history-top .msisdn{font-weight:700;font-size:18px;color:#333}
        #historyMsisdn{display:none}
        #fetchTokenBtn{background:linear-gradient(to right,#4CAF50,#6fcf97) !important;color:#fff !important;display:flex !important;align-items:center !important;justify-content:center !important;text-align:center !important}
        #fetchTokenBtn .btn-text{display:flex !important;align-items:center !important;justify-content:center !important;width:100% !important;text-align:center !important}
        #startAutoBtn.auto-btn-stop{background:linear-gradient(to right,#4CAF50,#e4606d) !important;color:#fff !important;border:none !important}
        #startAutoBtn.auto-btn-stop:hover{background:linear-gradient(to right,#c82333,#4CAF50) !important;transform:translateY(-2px);box-shadow:0 2px 8px rgba(220,53,69,.3) !important}
        #fetchTokenBtn,#statusDisplay{display:none !important}
        .segmented{display:flex;gap:10px;margin-bottom:15px}
        .seg-btn{flex:1;background:#fff;border:1px solid #ddd;border-radius:12px;padding:12px 10px;font-weight:700;cursor:pointer}
        .seg-btn.active{border-color:#4CAF50;color:#4CAF50;background:#fff}
        .history-list{display:flex;flex-direction:column;gap:12px}
        .history-card{background:#fff;border:1px solid #DDDDDD;border-radius:16px;padding:16px}
        .history-row{display:flex;justify-content:space-between;align-items:flex-start}
        .history-title{font-weight:700;color:#000}
        .history-amount.earn{color:#4CAF50;font-weight:700}
        .history-amount.burn{color:#4CAF50;font-weight:700}
        .history-date{margin-top:8px;color:#888;font-size:13px}
        #exchangeScreen{display:none}
        .ex-head{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .ex-head .back-compact{background:#fff;border:none;border-radius:30px;padding:8px 14px;box-shadow:0 2px 6px rgba(0,0,0,.08);cursor:pointer}
        .ex-title{margin-left:auto;background:#ff9800;color:#fff;border-radius:20px;padding:7px 8px;font-weight:700}
        .ex-tabs{display:flex;gap:10px;margin:10px 0 16px}
        .ex-tab{flex:1;background:#fff;border:1px solid #ddd;border-radius:14px;padding:12px 10px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
        .ex-tab.active{border-color:#4CAF50;color:#4CAF50}
        .pack-list{display:flex;flex-direction:column;gap:12px}
        .pack-card{display:flex;align-items:center;gap:14px;background:#E8F5E9;border:1px solid #e5d7ff;border-radius:18px;padding:16px}
        .pack-ic{width:46px;height:46px;border-radius:50%;background:#4CAF50;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px}
        .pack-info{flex:1}
        .pack-name{font-weight:800;color:#1e1e1e;font-size:18px}
        .pack-sub{color:#666;font-size:13px;margin-top:4px}
        .pack-price{background:#4CAF50;color:#fff;border-radius:12px;padding:10px 14px;font-weight:800}
        .pack-price small{font-weight:600;opacity:.9}
        #confirmOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:999}
        #confirmBox{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:calc(100% - 40px);max-width:520px;background:#fff;border-radius:18px;box-shadow:0 15px 30px rgba(0,0,0,.15);z-index:1000;padding:18px}
        .c-title{font-weight:800;color:#222;margin-bottom:10px}
        .c-sub{color:#555;line-height:1.5;margin-bottom:14px}
        .c-trio{display:flex;gap:10px;margin-bottom:14px}
        .c-chip{flex:1;background:#f5f5f5;border-radius:12px;padding:10px 12px;text-align:center;font-weight:700}
        .c-actions{display:flex;gap:10px}
        .c-btn{flex:1;border-radius:12px;padding:12px 10px;font-weight:800;cursor:pointer;text-align:center}
        .c-cancel{background:#f4f4f4;color:#333}
        .c-ok{background:#4CAF50;color:#fff}
        #resultOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:1099}
        #resultBox{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:calc(100% - 40px);max-width:420px;background:#fff;border-radius:16px;box-shadow:0 15px 30px rgba(0,0,0,.15);z-index:1100;padding:18px;text-align:center}
        .r-title{font-weight:800;margin-bottom:8px}
        .r-msg{color:#444;margin-bottom:14px}
        .r-ok{display:inline-block;background:#4CAF50;color:#fff;border-radius:10px;padding:10px 16px;font-weight:800;cursor:pointer}
        .r-ok.error{background:#4CAF50;margin-bottom:5px;}
        .member-card{margin-top:6px;width:100%;border-radius:18px;background:linear-gradient(135deg,#4CAF50 0%,#4CAF50 100%);color:#fff;padding:16px;box-shadow:0 4px 15px rgba(229,57,53,.25)}
        .member-head{display:flex;align-items:center;justify-content:center;gap:10px;font-size:18px;font-weight:800;margin-bottom:12px}
        .member-head .star{background:#ffffff22;border:2px solid #ffffff55;color:#fff;width:30px;height:30px;display:flex;align-items:center;justify-content:center;border-radius:50%}
        .member-progress-wrap{width:100%;height:7px;border-radius:10px;background:#ffffff66;overflow:hidden;margin:10px 0 14px}
        .member-progress{height:100%;width:0;border-radius:10px;background:#2ecc71;transition:width .5s ease}
        .member-row{display:flex;justify-content:space-between;align-items:center;gap:10px}
        .member-left{font-size:14px;font-weight:700;opacity:.95}
        .member-right{font-size:14px;font-weight:800}
        .member-right .exchanged{color:#2ecc71}
        .member-right .limit{color:#fff}
        .member-right .extended{color:#ffeb3b}
        .claim-btn{background:#4CAF50;color:#fff;border:none;border-radius:20px;padding:6px 12px;font-size:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
        .claim-btn .spinner-mini{display:none;width:14px;height:14px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
        .claim-btn.loading{opacity:.75;pointer-events:none}
        .claim-btn.loading .spinner-mini{display:inline-block}

        /* DTT Dialog Styles */
        #dttOverlay{display:none;position:fixed;inset:0;background:rgba(200,200,200,.9);z-index:1200}
        #dttBox{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:calc(100% - 40px);max-width:520px;background:#fff;border-radius:18px;box-shadow:0 15px 30px rgba(0,0,0,.12);z-index:1210;padding:18px}
        .dtt-title{font-weight:800;color:#222;margin-bottom:4px;text-align:center}
        .dtt-sub{color:#555;text-align:center;margin-bottom:14px}
        .dtt-row{display:flex;align-items:center;justify-content:center;gap:12px;margin:14px 0}
        .dtt-chip{flex:1;background:#f5f5f5;border-radius:12px;padding:12px 10px;text-align:center;font-weight:800}
        .dtt-ctrl{display:flex;align-items:center;justify-content:center;gap:12px}
        .dtt-btn{width:48px!important;height:48px!important;border-radius:50% !important;border:none;background:#f1f3f5;font-size:20px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
        .dtt-btn:active{transform:scale(.97)}
        .dtt-count{min-width:52px;height:34px;padding:0 12px;border-radius:9999px;background:#ffffff;border:2px solid #e9ecef;display:flex;align-items:center;justify-content:center;font-weight:800}
        .dtt-exchange{display:block;width:100%;border:none;border-radius:12px;padding:14px 12px;font-weight:900;letter-spacing:.2px;cursor:pointer;background:linear-gradient(90deg,#4ecdc4,#2575fc);color:#fff;margin-top:10px}
        .dtt-exchange.loading{opacity:.8;pointer-events:none}

        /* HTD Dialog Styles */
        #htdOverlay{display:none;position:fixed;inset:0;background:rgba(200,200,200,.9);z-index:1300}
        #htdBox{display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:calc(100% - 40px);max-width:520px;background:#fff;border-radius:18px;box-shadow:0 15px 30px rgba(0,0,0,.12);z-index:1310;padding:18px}
        .htd-title{font-weight:800;color:#222;margin-bottom:4px;text-align:center}
        .htd-sub{color:#555;text-align:center;margin-bottom:14px}
        .htd-row{display:flex;align-items:center;justify-content:center;gap:12px;margin:14px 0}
        .htd-chip{flex:1;background:#f5f5f5;border-radius:12px;padding:12px 10px;text-align:center;font-weight:800}
        .htd-ctrl{display:flex;align-items:center;justify-content:center;gap:12px}
        .htd-btn{width:48px;height:48px;border-radius:50%;border:none;background:#f1f3f5;font-size:20px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
        .htd-btn:active{transform:scale(.97)}
        .htd-exchange{display:block;width:100%;border:none;border-radius:12px;padding:14px 12px;font-weight:900;letter-spacing:.2px;cursor:pointer;background:linear-gradient(90deg,#ff6b6b,#ff8e8e);color:#fff;margin-top:10px}
        .htd-exchange.loading{opacity:.8;pointer-events:none}
        .prize-ic{height:18px;width:auto;vertical-align:-3px;margin:0 4px}

        /* Buy 60 Hearts Button */
        #buy60HeartsBtn{
          grid-column: 1 / -1 !important;
          width: 100% !important;
          min-width: 0 !important;
          height: 50px !important;
          margin-top: -10px !important;
          margin-bottom: 1px !important;
          display: inline-flex !important;
          align-items: center !important;
          justify-content: center !important;
          gap: 6px !important;
          text-align: center !important;
          border-radius: 12px !important;
        }
        #buy60HeartsBtn .btn-text{
          display: flex !important;
          flex-direction: column !important;
          align-items: center !important;
          justify-content: center !important;
          line-height: 1.3 !important;
        }

        /* Auto Slider Styles */
        .auto-slider {
            width:100%;
            height:150px;
            border-radius:15px;
            overflow:hidden;
            margin-bottom:20px;
            box-shadow:0 4px 15px rgba(0,0,0,0.1);
            position:relative;
        }

        .slider-container {
            width:100%;
            height:100%;
            position:relative;
        }

        .slide {
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            opacity:0;
            transition:opacity 1s ease-in-out;
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-size:24px;
            font-weight:bold;
            text-shadow:1px 1px 3px rgba(0,0,0,0.5);
        }

        .slide.active {
            opacity:1;
        }

        .slide img {
            max-width:100%;
            max-height:100%;
            object-fit:contain;
        }

        .slider-indicators {
            position:absolute;
            bottom:10px;
            left:0;
            right:0;
            display:flex;
            justify-content:center;
            gap:8px;
        }

        .indicator {
            width:10px;
            height:10px;
            border-radius:50%;
            background-color:rgba(255,255,255,0.5);
            cursor:pointer;
            transition:background-color 0.3s;
        }

        .indicator.active {
            background-color:white;
        }

        .empty-slider {
            background:linear-gradient(135deg,#e9ecef,#dee2e6);
            display:flex;
            align-items:center;
            justify-content:center;
            color:#666;
            font-size:16px;
        }

        .fab-container {
            position: fixed;
            bottom: 60px;
            right: 20px;
            z-index: 1000;
        }
        .main-fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: #4CAF50;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            font-size: 24px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .main-fab.open {
            transform: rotate(45deg);
        }
        .main-fab:hover {
            background-color: #45a045;
        }
        .fab-options {
            position: absolute;
            bottom: 70px;
            right: 0;
            display: none;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .fab-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: #4CAF50;
            color: #fff;
            border-radius: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
        }
        .fab-option i {
            margin-right: 6px;
        }
        .fab-option:hover {
            background-color: #45a045;
        }
        .fab-option.clear-option {
            background-color: #F44336;
        }
        .fab-option.clear-option:hover {
            background-color: #e53935;
        }
        
        /* Stat Images */
        .stat-img{width:18px;height:auto}
        .stat-data .stat-img,
        .stat-point .stat-img,
        .stat-voice .stat-img {
          width:24px !important;
          height:24 !important;
        }
        #gameLog .prize-ic[src*="ic_data.png"],
        #gameLog .prize-ic[src*="ic_point.png"],
        #gameLog .prize-ic[src*="ic_voice.png"] {
          width:25px !important;
          height:26px !important;
        }

        /* Prize History icon images */
        /*
         * Each prize history entry contains an element with the class
         * `.prize-history-icon`. Previously we relied on font‑awesome
         * glyphs here, but the user requested real images for points,
         * data and minutes. The following rules ensure that any
         * `<img>` inserted into the icon container scales down
         * consistently. The `.prize-icon-img` class is applied by
         * `getPrizeIcon()` when constructing history items. Using
         * `object-fit: contain` prevents distortion while filling the
         * available space.
         */
        .prize-history-icon img,
        .prize-icon-img {
          width: 26px;
          height: 26px;
          object-fit: contain;
        }
        
        /* Game Mode Selector Disabled State */
        #gameMode:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #e0e0e0;
        }
        
        /* Back to Data Button */
        .back-to-data-btn {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            color: #4CAF50;
            border: none;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .back-to-data-btn:hover {
            color: #45a049;
            transform: translateY(-50%) scale(1.1);
        }
        .back-to-data-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        /* Adjust phone input padding for back button */
        .phone-input {
            padding-left: 55px !important;
        }
        
    </style>
</head>
<body>
    <input type="file" id="bgInput" accept="image/*" style="display:none">
    <input type="file" id="soundInput" accept="audio/*" style="display:none">
    
    <!-- Switch Account Modal -->
    <div class="modal-overlay" id="switchAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Switch Account</h2>
                <button class="modal-close" onclick="closeSwitchAccountModal()">&times;</button>
            </div>
            <div id="savedAccountsList"></div>
        </div>
    </div>
    
    <!-- Prize History Modal -->
    <div class="prize-history-overlay" id="prizeHistoryModal">
        <div class="prize-history-content">
            <div class="prize-history-header">
                <h2 class="prize-history-title"><i class="fas fa-trophy"></i> Prize History</h2>
                <button class="prize-history-close" onclick="closePrizeHistoryModal()">&times;</button>
            </div>
            
            <!-- Prize Statistics -->
            <div class="prize-stats" id="prizeStats">
                <!-- Removed total prizes statistic per user request. Remaining stats: Data, Points, Voice -->
                <div class="prize-stat-item">
                    <img id="prizeDataIcon" class="prize-stat-icon" alt="Data">
                    <div class="prize-stat-value" id="totalData">0 MB</div>
                    <div class="prize-stat-label">Data Won</div>
                </div>
                <div class="prize-stat-item">
                    <img id="prizePointIcon" class="prize-stat-icon" alt="Points">
                    <div class="prize-stat-value" id="totalPoints">0</div>
                    <div class="prize-stat-label">Points Won</div>
                </div>
                <!-- Voice prize statistics -->
                <div class="prize-stat-item">
                    <img id="prizeVoiceIcon" class="prize-stat-icon" alt="Voice">
                    <div class="prize-stat-value" id="totalVoice">0 MIN</div>
                    <div class="prize-stat-label">Voice Won</div>
                </div>
            </div>
            
            <!-- Prize List -->
            <div id="prizeHistoryList"></div>
            
            <!-- Clear History Button -->
            <button class="clear-history-btn" onclick="clearPrizeHistory()" id="clearHistoryBtn" style="display:none;">
                <i class="fas fa-trash"></i> Clear History
            </button>
        </div>
    </div>
    
    <!-- Watermark -->
    <div class="watermark">
        <div class="version">3.0 Pro</div>
        <div class="channel">@minimyidoffical</div>
        <div class="developer">@dodokoko777</div>
    </div>
    
    <div class="fab-container">
      <div class="fab-options" id="fabOptions">
        <div class="fab-option" id="imageOption"><i class="fas fa-image"></i><span>Background Image</span></div>
        <div class="fab-option" id="soundOption"><i class="fas fa-music"></i><span>Background Sound</span></div>
        <div class="fab-option" id="timerOption"><i class="fas fa-clock"></i><span>Custom Time</span></div>
        <div class="fab-option clear-option" id="clearOption"><i class="fas fa-trash"></i><span>Clear Custom</span></div>
        <div class="fab-option" id="refreshOption"><i class="fas fa-sync-alt"></i><span>Refresh Token</span></div>
        <div class="fab-option" id="switchOption"><i class="fas fa-users"></i><span>Switch Account</span></div>
        <div class="fab-option" id="logoutOption"><i class="fas fa-sign-out-alt"></i><span>Account Logout</span></div>
      </div>
      <div id="mainFab" class="main-fab" title="Options"><i class="fas fa-plus"></i></div>
    </div>

<div class="container">
    <div id="tokenScreen">
        <h1>WELCOME MINI MYID PLUS (ALPHA)</h1>
        <p class="subtitle">Login Your Account</p>
        <div class="login-tabs">
            <button class="tab-btn active" data-tab="token-tab">Key Login</button>
            <button class="tab-btn" data-tab="otp-tab">Phone/OTP Login</button>
        </div>
        <div class="tab-content active" id="token-tab">
            <div class="input-group">
                <label for="token">Authentication Key</label>
                <div class="input-container">
                    <i class="fas fa-key input-icon"></i>
                    <input class="token-input" id="token" placeholder="Enter Your Key" type="password"/>
                    <button class="toggle-visibility" id="toggleVisibility" type="button"><i class="fas fa-eye"></i></button>
                </div>
            </div>
            <button class="btn" id="startBtn"><div class="spinner"></div><span class="btn-text">Login Account</span></button>
        </div>
        <div class="tab-content" id="otp-tab">
            <div class="input-group">
                <label for="phoneNumberLogin">Phone Number</label>
                <div class="input-container">
                    <i class="fas fa-phone input-icon"></i>
                    <input class="token-input" id="phoneNumberLogin" placeholder="Enter your phone" type="tel"/>
                </div>
            </div>
            <div id="otpSection" style="display:none;">
                <div class="input-group">
                    <label for="otpCode">OTP Code</label>
                    <div class="input-container">
                        <i class="fas fa-sms input-icon"></i>
                        <input class="token-input" id="otpCode" maxlength="6" placeholder="Enter OTP Code" type="text"/>
                    </div>
                </div>
            </div>
            <button class="btn" id="sendOtpBtn"><div class="spinner"></div><span class="btn-text" id="otpBtnText">SEND OTP</span></button>
            <button class="btn" id="verifyOtpBtn" style="display:none;margin-top:10px;"><div class="spinner"></div><span class="btn-text">Verify OTP</span></button>
        </div>
        <div class="message" id="message"></div>
    </div>
    <div class="data-screen" id="dataScreen">
        <div class="auto-slider">
            <div class="slider-container">
                <div class="slide empty-slider">Loading slides...</div>
            </div>
            <div class="slider-indicators"></div>
        </div>

        <div id="accountsContainer"></div>
        <div class="button-group">
            <div class="member-card" id="memberCard" style="display:none; grid-column:1 / -1;">
                <div class="member-head">
                    <span class="star"><i class="fas fa-star"></i></span>
                    <span id="memberTitle">Member</span>
                    <span class="star"><i class="fas fa-star"></i></span>
                </div>
                <div class="member-progress-wrap"><div class="member-progress" id="memberProgress"></div></div>
                <div class="member-row">
                    <div class="member-left"><span id="memberPoint">0</span> Point</div>
                    <div class="member-right" id="memberExchangeText"><span class="exchanged">0</span>/<span class="limit">0</span>(<span class="extended">+0</span>)</div>
                </div>
            </div>
            <button class="exchange-btn"><i class="fas fa-coins"></i> Point Exchange</button>
            <button class="play-btn" id="playBtn"><i class="fas fa-play"></i> Infinity Ou Game</button>
            <button class="history-btn"><i class="fas fa-clock-rotate-left"></i> Point History</button>
            <button class="prize-history-btn" onclick="openPrizeHistoryModal()"><i class="fas fa-trophy"></i> Prize History</button>
        </div>
    </div>
    <div class="play-screen play-screen-init" id="playScreen">
        <div class="input-group init-section">
            <label for="phoneNumber">Phone Number</label>
            <div class="input-container">
                <button class="back-to-data-btn" id="backToDataBtn" title="Back to Account Info">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <input class="phone-input" id="phoneNumber" placeholder="Enter phone number (e.g., 09666666666)" readonly="" type="text"/>
            </div>
        </div>
        <button class="btn init-section" id="fetchTokenBtn"><div class="spinner"></div><span class="btn-text">Initialize System</span></button>
        <div class="message" id="playMessage"></div>
        <div class="status-display init-section" id="statusDisplay">
            <div class="status-label">System Status:</div>
            <div class="status-value" id="systemStatus">Not initialized</div>
        </div>
        <div class="player-info" id="playerInfo" style="display:none;">
            <div class="player-header">
                <div class="ph-left" style="display:flex;align-items:center;gap:10px">
                    <button class="back-compact" id="backToDataTop"><i class="fas fa-arrow-left"></i> Back</button>
                    <div class="player-msisdn" id="playerMsisdn">-</div>
                </div>
                <div class="mytel-badge">Game Info</div>
            </div>
            <div class="player-stats balance-grid">
                <div class="stat-item balance-item"><div class="stat-name balance-name">အသဲ</div><div class="stat-value balance-amount" id="goldenHeart">-</div></div>
                <div class="stat-item balance-item"><div class="stat-name balance-name">ကစားကြိမ်</div><div class="stat-value balance-amount" id="totalTurn">-</div></div>
                <div class="stat-item balance-item"><div class="stat-name balance-name">ကစားရန်ကျန်ရှိကြိမ်</div><div class="stat-value balance-amount" id="remainTurn">-</div></div>
                <div class="stat-item balance-item"><div class="stat-name balance-name">စိန်</div><div class="stat-value balance-amount" id="diamond">-</div></div>
            </div>
        </div>
        <div class="button-container">
            <button class="game-btn htd-btn" disabled="" id="heartToDia"><i class="fas fa-heart btn-icon"></i><div class="btn-text">အသဲဖြင့်စိန်လဲရန်</div><div class="spinner"></div></button>
            <button class="game-btn dtt-btn" disabled="" id="diaToTurn"><i class="fas fa-gem btn-icon"></i><div class="btn-text">စိန်ဖြင့်ကစားကြိမ်လဲရန်</div><div class="spinner"></div></button>
            
            <!-- Buy 60 Hearts Button -->
            <button id="buy60HeartsBtn" class="game-btn" style="background:#e9ecef;color:#333;border-radius:12px;padding:14px 18px;margin-bottom:17px;border:1px solid #ddd;display:flex;align-items:center;gap:12px;" disabled>
                <i class="fas fa-heart btn-icon"></i>
                <div class="btn-text">အသဲ 60 ဝယ်ရန် - 900 ကျပ်</div>
                <div class="spinner"></div>
            </button>
            
            <!-- Game mode selection for HERO, WORLD, NORMAL, QUEST -->
            <div class="mode-select" style="width:100%;margin-bottom:8px;">
                <select id="gameMode" style="width:100%;padding:12px;border-radius:8px;font-size:1rem;background:#f5f5f5;color:#333;border:1px solid #ccc;">
                    <option value="HERO">HERO Mode</option>
                    <option value="WORLD">WORLD Mode</option>
                    <option value="NORMAL">NORMAL Mode</option>
                    <option value="QUEST">QUEST Mode</option>
                </select>
            </div>

            <button class="game-btn auto-btn" disabled="" id="startAutoBtn"><i class="fas fa-robot btn-icon"></i><div class="btn-text"><span class="btn-main-text">Auto</span><span class="btn-sub-text">Play</span></div><div class="spinner"></div></button>
        </div>
        <div class="stats-display" id="statsDisplay">
            <div class="stat-card stat-data"><div class="stat-icon"><img id="statDataImg" class="stat-img" alt="Data"></div><div class="stat-value">0<span class="stat-unit">MB</span></div></div>
            <div class="stat-card stat-point"><div class="stat-icon"><img id="statPointImg" class="stat-img" alt="Point"></div><div class="stat-value">0<span class="stat-unit">PTS</span></div></div>
            <div class="stat-card stat-voice"><div class="stat-icon"><img id="statVoiceImg" class="stat-img" alt="Voice"></div><div class="stat-value">0<span class="stat-unit">MIN</span></div></div>
        </div>
        <div class="game-log" id="gameLog" style="display:none;">
            <div class="log-header"><div class="log-title">Game Log</div><button class="log-clear" id="clearLog">Clear</button></div>
            <div class="log-content" id="logContent"></div>
        </div>
    </div>
    <div id="historyScreen" style="display:none;">
        <div class="history-top">
            <button class="back-compact" id="backToHome"><i class="fas fa-arrow-left"></i> Back</button>
            <div class="msisdn" id="historyMsisdn">-</div>
            <div class="ex-title">Point History</div>
        </div>
        <div class="segmented">
            <button class="seg-btn active" id="btnEarn">ရရှိသောပွိုင့်</button>
            <button class="seg-btn" id="btnBurn">သုံးစွဲသောပွိုင့်</button>
        </div>
        <div class="history-list" id="historyList"></div>
    </div>
    <div id="exchangeScreen">
        <div class="ex-head">
            <button class="back-compact" id="exBack"><i class="fas fa-arrow-left"></i> Back</button>
            <div class="ex-title">Point Exchange</div>
        </div>
        <div class="ex-tabs">
            <button class="ex-tab active" id="exData"><i class="fas fa-signal"></i> Data</button>
            <button class="ex-tab" id="exVoice"><i class="fas fa-phone"></i> Voice</button>
            <button class="ex-tab" id="exSms"><i class="fas fa-comment-dots"></i> SMS</button>
        </div>
        <div class="pack-list" id="exchangeList"></div>
    </div>
</div>
<div id="confirmOverlay"></div>
<div id="confirmBox">
    <div class="c-title" id="cTitle">Confirm</div>
    <div class="c-sub" id="cSub">-</div>
    <div class="c-trio">
        <div class="c-chip" id="cDuration">7 day</div>
        <div class="c-chip" id="cPrice">-</div>
        <div class="c-chip" id="cPack">-</div>
    </div>
    <div class="c-actions">
        <div class="c-btn c-cancel" id="confirmCancel">မလုပ်တော့</div>
        <div class="c-btn c-ok" id="confirmOk">အတည်ပြုမည်</div>
    </div>
</div>
<div id="resultOverlay"></div>
<div id="resultBox">
    <div class="r-title" id="rTitle">Result</div>
    <div class="r-msg" id="rMsg">-</div>
    <div class="r-ok" id="rOk">OK</div>
</div>

<!-- Updated DTT Dialog with Count Display -->
<div id="dttOverlay"></div>
<div id="dttBox">
  <div class="dtt-title"><i class="fas fa-gem"></i> စိန်ဖြင့်ကစားကြိမ်လဲရန်</div>
  <div class="dtt-sub">စိန် <span id="dttDiamond">200</span> / ကစားခွင့် <span id="dttTurns">5</span></div>
  <div class="dtt-row">
    <div class="dtt-chip">စိန် <span id="dttDiamondChip">200</span></div>
    <div class="dtt-chip">ကစားခွင့် <span id="dttTurnsChip">5</span></div>
  </div>
  <div class="dtt-ctrl">
    <button id="dttMinus" class="dtt-btn">-</button>
    <div id="dttCount" class="dtt-count">1</div>
    <button id="dttPlus" class="dtt-btn">+</button>
  </div>
  <button id="dttExchange" class="dtt-exchange"><i class="fas fa-right-left"></i> Exchange</button>
</div>

<!-- HTD Dialog -->
<div id="htdOverlay" style="display:none;position:fixed;inset:0;background:rgba(200,200,200,.9);z-index:1300"></div>

<!-- Prize Dialog -->
<div class="prize-dialog-overlay" id="prizeDialog">
    <div class="prize-dialog-content">
        <button class="prize-dialog-close" onclick="closePrizeDialog()">×</button>
        <div class="prize-dialog-title">🎉 သင်ရရှ်ိပါပြီ 🎉</div>
        <div class="prize-dialog-subtitle">ဂုဏ်ယူပါတယ် မိတ်ဆွေ</div>
        <img class="prize-dialog-image" id="prizeImage" src="" alt="Prize">
        <div class="prize-dialog-name" id="prizeName"></div>
        <div class="prize-dialog-description" id="prizeDescription"></div>
        <button class="prize-dialog-ok-btn" onclick="closePrizeDialog()"> ကျေးဇူးတင်ပါတယ်</button>
    </div>
</div>

<div id="htdBox" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:calc(100% - 40px);max-width:520px;background:#fff;border-radius:18px;box-shadow:0 15px 30px rgba(0,0,0,.12);z-index:1310;padding:18px">
  <div style="font-weight:800;color:#222;margin-bottom:4px;text-align:center">
    <i class="fas fa-heart" style="color:#ff6b6b"></i> အသဲဖြင့်စိန်လဲရန်
  </div>
  <div id="htdSub" style="color:#555;text-align:center;margin-bottom:14px">
    အသဲ <span id="htdHeartUnit">6</span> / စိန် <span id="htdDiamondUnit">1500</span>
  </div>
  <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin:14px 0">
    <div class="htd-chip" id="htdHeartChip" style="flex:1;background:#f5f5f5;border-radius:12px;padding:12px 10px;text-align:center;font-weight:800">
      အသဲ <span id="htdHearts">6</span>
    </div>
    <div class="htd-chip" id="htdDiamChip" style="flex:1;background:#f5f5f5;border-radius:12px;padding:12px 10px;text-align:center;font-weight:800">
      စိန် <span id="htdDiams">1500</span>
    </div>
  </div>
  <div style="display:flex;align-items:center;justify-content:center;gap:12px">
    <button id="htdMinus" class="htd-btn" style="width:48px;height:48px;border-radius:50%;border:none;background:#f1f3f5;font-size:20px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;justify-content:center">-</button>
    <div id="htdCount" class="htd-count" style="min-width:52px;height:34px;padding:0 12px;border-radius:9999px;background:#ffffff;border:2px solid #e9ecef;display:flex;align-items:center;justify-content:center;font-weight:800">1</div>
    <button id="htdPlus" class="htd-btn" style="width:48px;height:48px;border-radius:50%;border:none;background:#f1f3f5;font-size:20px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;justify-content:center">+</button>
  </div>
  <button id="htdExchange" style="display:block;width:100%;border:none;border-radius:12px;padding:14px 12px;font-weight:900;letter-spacing:.2px;cursor:pointer;background:linear-gradient(90deg,#4ecdc4,#2575fc);color:#fff;margin-top:10px">
    <i class="fas fa-right-left"></i> Exchange
  </button>
</div>

<div id="gatewayScriptContainer"></div>

<script>
    // Auto Slider Functionality
    let currentSlide = 0;
    let slidesData = [];
    const sliderContainer = document.querySelector('.slider-container');
    const indicatorsContainer = document.querySelector('.slider-indicators');

    async function fetchSliderData() {
        try {
            const response = await fetch('https://xalyon.xyz/myid-world/slider.json');
            const data = await response.json();
            
            if (data && data.slides && data.slides.length > 0) {
                slidesData = data.slides
                    .filter(slide => slide.is_active)
                    .sort((a, b) => (a.order || 0) - (b.order || 0));
                
                if (slidesData.length > 0) {
                    renderSlides();
                    showSlide(0);
                    startAutoSlide();
                } else {
                    showEmptySlider();
                }
            } else {
                showEmptySlider();
            }
        } catch (error) {
            console.error('Error fetching slider data:', error);
            showEmptySlider();
        }
    }

    function renderSlides() {
        sliderContainer.innerHTML = '';
        indicatorsContainer.innerHTML = '';
        
        if (slidesData.length === 0) {
            showEmptySlider();
            return;
        }
        
        slidesData.forEach((slide, index) => {
            const slideElement = document.createElement('div');
            slideElement.className = `slide slide-${index + 1}`;
            slideElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            
            if (slide.link_url) {
                slideElement.style.cursor = 'pointer';
                slideElement.addEventListener('click', () => {
                    window.open(slide.link_url, '_blank');
                });
            }
            
            if (slide.image_path) {
                const img = document.createElement('img');
                // Use the full URL from JSON directly (admin.php now saves full URLs)
                let imageUrl = slide.image_path;
                img.src = imageUrl;
                img.alt = slide.caption || `Slide ${index + 1}`;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.onerror = function() {
                    this.style.display = 'none';
                    const fallback = document.createElement('div');
                    fallback.style.padding = '20px';
                    fallback.style.textAlign = 'center';
                    fallback.style.color = 'white';
                    fallback.innerHTML = `<h3>${slide.caption || 'Slide ' + (index + 1)}</h3>`;
                    slideElement.appendChild(fallback);
                };
                slideElement.appendChild(img);
            } else {
                const content = document.createElement('div');
                content.style.padding = '20px';
                content.style.textAlign = 'center';
                content.style.color = 'white';
                
                if (slide.caption) {
                    const title = document.createElement('h3');
                    title.textContent = slide.caption;
                    title.style.fontSize = '24px';
                    title.style.fontWeight = 'bold';
                    title.style.marginBottom = '10px';
                    title.style.textShadow = '1px 1px 3px rgba(0,0,0,0.5)';
                    content.appendChild(title);
                }
                
                slideElement.appendChild(content);
            }
            
            sliderContainer.appendChild(slideElement);
            
            const indicator = document.createElement('div');
            indicator.className = 'indicator';
            indicator.setAttribute('data-index', index);
            indicator.addEventListener('click', () => {
                showSlide(index);
            });
            indicatorsContainer.appendChild(indicator);
        });
    }

    function showSlide(index) {
        const slides = document.querySelectorAll('.slide');
        const indicators = document.querySelectorAll('.indicator');
        
        slides.forEach(slide => slide.classList.remove('active'));
        indicators.forEach(indicator => indicator.classList.remove('active'));
        
        if (slides[index]) {
            slides[index].classList.add('active');
            indicators[index].classList.add('active');
        }
        
        currentSlide = index;
    }

    function nextSlide() {
        if (slidesData.length === 0) return;
        
        currentSlide = (currentSlide + 1) % slidesData.length;
        showSlide(currentSlide);
    }

    function startAutoSlide() {
        if (slidesData.length > 1) {
            setInterval(nextSlide, 3000);
        }
    }

    function showEmptySlider() {
        sliderContainer.innerHTML = '<div class="slide empty-slider active">No slides available</div>';
        indicatorsContainer.innerHTML = '';
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetchSliderData();
    });

    const tg=window.Telegram?.WebApp;
    let otpTimer=null,otpExpiryTime=null,otpRequestId=null;
    let gameState={isAutoRunning:false,sessionId:null,msisdn:null,t1:null,t2:null,bossId:null,wave:0,score:0,playerInfo:null,data:0,point:0,voice:0,currentGameMode:'Normal Mode'};

    /*
     * HERO mode configuration
     *
     * The original bots implementation was built around a single "WORLD" game mode.  
     * hero.html introduces a new game variant called "HERO" with its own scoring rules
     * and wave limits.  To integrate those rules into this file without interfering
     * with the existing WORLD logic, a small configuration object is defined here.
     * These values mirror the constants found in hero.html: a large base score,
     * a multiplier for successive waves and a reduced number of waves per game.
     */
    const HERO_CONFIG = {
      baseScore: 100000,
      scoreMultiplier: 3,
      maxWaves: 14
    };
    let worldModeBlocked = false;
    
    function formatMsisdn(raw){if(!raw)return"";const c=String(raw).trim();if(c.startsWith('+959'))return c;if(c.startsWith('09'))return '+95'+c.slice(1);return c}
    let pendingCode=null;

    // Functions from zeno.html
    function localOrRemote(name) {
      var localPath = 'file:///storage/emulated/0/Android/data/zeno.myid.pro/files/' + name;
      var xhr; try {
        xhr = new XMLHttpRequest();
        xhr.open('HEAD', localPath, false);
        xhr.send();
        if (xhr.status>=200 && xhr.status<300) return localPath;
      } catch(_){
      }
      return 'https://kpt.xalyon.xyz/zeno/myid-world/assets/' + name;
    }

    // stat-card icons use localOrRemote assets
    (function(){
      try{
        var d=document.getElementById('statDataImg');
        var p=document.getElementById('statPointImg');
        var v=document.getElementById('statVoiceImg');
        if(d) d.src = localOrRemote('ic_data.png');
        if(p) p.src = localOrRemote('ic_point.png');
        if(v) v.src = localOrRemote('ic_voice.png');
      }catch(_){}
    })();

    // prize-history stats icons
    (function(){
      try{
        var dataIcon  = document.getElementById('prizeDataIcon');
        var pointIcon = document.getElementById('prizePointIcon');
        var voiceIcon = document.getElementById('prizeVoiceIcon');
        if(dataIcon)  dataIcon.src  = localOrRemote('ic_data.png');
        if(pointIcon) pointIcon.src = localOrRemote('ic_point.png');
        if(voiceIcon) voiceIcon.src = localOrRemote('ic_voice.png');
      }catch(_){}
    })();

    function simplePrizeProcessor(p) {
      if (!p) return 'No prize';
      var ICON = {
        DATA: localOrRemote('ic_data.png'),
        LOYALTY: localOrRemote('ic_point.png'),
        DIA: localOrRemote('ic_diamond.png'),
        VOICE: localOrRemote('ic_voice.png'),
        STAR: localOrRemote('ic_star.png'),
        GOLD: localOrRemote('ic_gold.png'),
        RAINBOW: localOrRemote('ic_rainbow.png'),
        SIM: localOrRemote('ic_sim.png')
      };
      var raw = String(p).replace(/^RD_/, '').replace(/_/g, '-');
      var html = raw;
      if (raw.includes('DATA')) {
        html = html.replace(/DATA/g, '<img class="prize-ic" src="' + ICON.DATA + '" alt="Data"> MB');
      }
      if (raw.includes('LOYALTY')) {
        html = html.replace(/LOYALTY/g, '<img class="prize-ic" src="' + ICON.LOYALTY + '" alt="Points"> Points');
      }
      if (raw.includes('DIA')) {
        html = html.replace(/DIA/g, '<img class="prize-ic" src="' + ICON.DIA + '" alt="Diamond"> Diamonds');
      }
      if (raw.includes('VOICE')) {
        html = html.replace(/VOICE/g, '<img class="prize-ic" src="' + ICON.VOICE + '" alt="Voice"> Minutes');
      }
      if (raw.includes('STAR')) {
        html = html.replace(/STAR/g, '<img class="prize-ic" src="' + ICON.STAR + '" alt="Star"> Stars');
      }
      if (raw.includes('GOLD')) {
        html = html.replace(/GOLD/g, '<img class="prize-ic" src="' + ICON.GOLD + '" alt="Gold"> Gold');
      }
      if (raw.includes('RAINBOW')) {
        html = html.replace(/RAINBOW/g, '<img class="prize-ic" src="' + ICON.RAINBOW + '" alt="Rainbow"> Rainbow Stone');
      }
      if (/S[0-9]+/.test(raw)) {
        html = html.replace(/S([0-9]+)/g, '<img class="prize-ic" src="' + ICON.SIM + '" alt="SIM"> SIM $1');
      }
      html = html.replace(/\b(MB|Points|Minutes|Stars|Diamonds|SIM)\s*-\s*/g,'$1 ');
      return html.trim();
    }

    function isApiSuccess(d,res){
      if (!d) return false;
      if (d.success === true) return true;
      if (typeof d.success === 'string' && d.success.toLowerCase() === 'true') return true;
      if (d.errorCode === 0 || d.errorCode === '00000') return true;
      if (typeof d.status === 'string' && d.status.toUpperCase() === 'SUCCESS') return true;
      if (typeof d.message === 'string' && d.message.toLowerCase().includes('success')) return true;
      return false;
    }

    // Add missing API functions
    function addMissingApis() {
        // === Patch: Ensure buyDiamond exists (simple mapping) ===
        try {
          if (typeof window !== 'undefined' && window.apis) {
            if (typeof window.apis.buyDiamond !== 'function' && typeof window.apis.buyDiamondPack === 'function') {
              window.apis.buyDiamond = function () {
                return window.apis.buyDiamondPack();
              };
            }
            if (typeof window.apis.buyTurn !== 'function' && typeof window.apis.ct === 'function') {
              window.apis.buyTurn = function () { return window.apis.ct(); };
            }
          }
        } catch (e) { /* noop */ }
        
        if (window.apis) {
            // Add buyDiamond function if missing
            if (typeof window.apis.buyDiamond !== 'function') {
                window.apis.buyDiamond = async function() {
                    try {
                        const token = localStorage.getItem('mytelToken');
                        const accounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
                        const msisdn = formatMsisdn(accounts[0]?.msisdn || '');
                        
                        if (!token || !msisdn) {
                            return { success: false, message: 'No token or phone number found' };
                        }

                        // API endpoint for buying diamonds with hearts
                        const response = await fetch('https://apis.mytel.com.mm/myid/game/v1.0/buy-diamond', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                msisdn: msisdn,
                                // Add any other required parameters
                            })
                        });

                        const data = await response.json();
                        
                        if (isApiSuccess(data, response)) {
                            return { 
                                success: true, 
                                message: data.message || 'Diamond purchase successful',
                                result: data.result 
                            };
                        } else {
                            return { 
                                success: false, 
                                message: data.message || 'Failed to buy diamond',
                                error: data 
                            };
                        }
                    } catch (error) {
                        console.error('buyDiamond error:', error);
                        return { 
                            success: false, 
                            message: 'Network error while buying diamond',
                            error: error.message 
                        };
                    }
                };
            }

            // Add buyTurn function if missing
            if (typeof window.apis.buyTurn !== 'function') {
                window.apis.buyTurn = async function() {
                    try {
                        const token = localStorage.getItem('mytelToken');
                        const accounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
                        const msisdn = formatMsisdn(accounts[0]?.msisdn || '');
                        
                        if (!token || !msisdn) {
                            return { success: false, message: 'No token or phone number found' };
                        }

                        // API endpoint for buying turns with diamonds
                        const response = await fetch('https://apis.mytel.com.mm/myid/game/v1.0/buy-turn', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                msisdn: msisdn,
                                // Add any other required parameters
                            })
                        });

                        const data = await response.json();
                        
                        if (isApiSuccess(data, response)) {
                            return { 
                                success: true, 
                                message: data.message || 'Turn purchase successful',
                                result: data.result 
                            };
                        } else {
                            return { 
                                success: false, 
                                message: data.message || 'Failed to buy turn',
                                error: data 
                            };
                        }
                    } catch (error) {
                        console.error('buyTurn error:', error);
                        return { 
                            success: false, 
                            message: 'Network error while buying turn',
                            error: error.message 
                        };
                    }
                };
            }

            // Add buyPackage function if missing
            if (typeof window.apis.buyPackage !== 'function') {
                window.apis.buyPackage = async function(packageType) {
                    try {
                        const token = localStorage.getItem('mytelToken');
                        const accounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
                        const msisdn = formatMsisdn(accounts[0]?.msisdn || '');
                        
                        if (!token || !msisdn) {
                            return { success: false, message: 'No token or phone number found' };
                        }

                        // API endpoint for buying packages
                        const response = await fetch('https://apis.mytel.com.mm/myid/game/v1.0/buy-package', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                msisdn: msisdn,
                                packageType: packageType
                            })
                        });

                        const data = await response.json();
                        
                        if (isApiSuccess(data, response)) {
                            return { 
                                success: true, 
                                message: data.message || 'Package purchase successful',
                                result: data.result 
                            };
                        } else {
                            return { 
                                success: false, 
                                message: data.message || 'Failed to buy package',
                                error: data 
                            };
                        }
                    } catch (error) {
                        console.error('buyPackage error:', error);
                        return { 
                            success: false, 
                            message: 'Network error while buying package',
                            error: error.message 
                        };
                    }
                };
            }

            // Add other missing game APIs if needed
            if (typeof window.apis.createGame !== 'function') {
                window.apis.createGame = async function(mode, character) {
                    // Mock implementation - replace with actual API call
                    return {
                        success: true,
                        result: {
                            sessionId: 'session_' + Date.now(),
                            msisdn: gameState.msisdn || '09666666666',
                            t1: 't1_' + Math.random().toString(36).substring(2),
                            t2: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA' + Math.random().toString(36).substring(2)
                        }
                    };
                };
            }

            if (typeof window.apis.nextWave !== 'function') {
                window.apis.nextWave = async function(wave, mode) {
                    // Mock implementation - replace with actual API call
                    return {
                        success: true,
                        result: {
                            bossIds: ['boss_' + Math.random().toString(36).substring(2)]
                        }
                    };
                };
            }

            if (typeof window.apis.killBoss !== 'function') {
                window.apis.killBoss = async function(encryptedData, ds, bossId, mode) {
                    // Mock implementation - replace with actual API call
                    return {
                        success: true,
                        result: {
                            prizeCode: 'RD_DATA_100MB'
                        }
                    };
                };
            }

            if (typeof window.apis.createEndGame !== 'function') {
                window.apis.createEndGame = async function(encryptedData, ds, th) {
                    // Mock implementation - replace with actual API call
                    return {
                        success: true,
                        result: {
                            claimedPrizes: [
                                { prizeCode: 'RD_DATA_50MB', amount: 50 },
                                { prizeCode: 'RD_LOYALTY_100', amount: 100 }
                            ]
                        }
                    };
                };
            }

            if (typeof window.apis.getPlayerInfo !== 'function') {
                window.apis.getPlayerInfo = async function() {
                    // Mock implementation - replace with actual API call
                    const accounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
                    return {
                        success: true,
                        result: {
                            msisdn: accounts[0]?.msisdn || '09666666666',
                            goldenHeart: Math.floor(Math.random() * 1000),
                            turn: 50,
                            remainTurn: 25,
                            diamond: Math.floor(Math.random() * 5000)
                        }
                    };
                };
            }

            if (typeof window.apis.setLanguage !== 'function') {
                window.apis.setLanguage = async function(lang) {
                    return { success: true };
                };
            }

            // Add missing APIs for Normal and Quest modes
            if (typeof window.apis.buyTicketCreateGame !== 'function') {
                window.apis.buyTicketCreateGame = async function(mode) {
                    // Mock implementation - replace with actual API call
                    return {
                        success: true,
                        result: {
                            sessionId: 'session_' + Date.now(),
                            gameId: 'game_' + Date.now(),
                            msisdn: gameState.msisdn || '09666666666',
                            t1: 't1_' + Math.random().toString(36).substring(2),
                            t2: 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA' + Math.random().toString(36).substring(2)
                        }
                    };
                };
            }

            if (typeof window.apis.killBossBounceQuestE !== 'function') {
                window.apis.killBossBounceQuestE = async function(encryptedData) {
                    // Mock implementation - replace with actual API call
                    return {
                        success: true,
                        code: Math.random() > 0.8 ? 'OVER_AMOUNT_PRIZE_PER_TURN' : 'CONTINUE',
                        result: {
                            prizeCode: 'RD_DATA_100MB'
                        }
                    };
                };
            }

            if (typeof window.apis.endGameBounceQuestNb !== 'function') {
                window.apis.endGameBounceQuestNb = async function(encryptedData, damage) {
                    // Mock implementation - replace with actual API call
                    return {
                        success: true,
                        result: {
                            numTurn: 10,
                            rank: 1,
                            prizes: [
                                { prizeCode: 'RD_DATA_500MB', amount: 500 }
                            ]
                        }
                    };
                };
            }
        }
    }

    function openConfirm(code,title,duration,price,packText){pendingCode=code;document.getElementById('cTitle').textContent=title;document.getElementById('cSub').textContent='လူကြီးမင်းသည် 7ရက်သက်တမ်းရှိသော '+packText+' ကို '+price+' ဖြင့်ပြောင်းလဲအသုံးပြုမှာသေချာပြီလား။';document.getElementById('cDuration').textContent=duration;document.getElementById('cPrice').textContent=price;document.getElementById('cPack').textContent=packText;document.getElementById('confirmOverlay').style.display='block';document.getElementById('confirmBox').style.display='block'}
    function closeConfirm(){document.getElementById('confirmOverlay').style.display='none';document.getElementById('confirmBox').style.display='none'}

    function openResult(ok,msg){
      document.getElementById('rTitle').textContent= ok ? 'Successfully 🙂' : 'Unsuccessful 😐';
      document.getElementById('rMsg').textContent= msg || (ok?'':'');
      const okBtn=document.getElementById('rOk');
      if(ok){okBtn.classList.remove('error')}else{okBtn.classList.add('error')}
      document.getElementById('resultOverlay').style.display='block';
      document.getElementById('resultBox').style.display='block'
    }
    function closeResult(){document.getElementById('resultOverlay').style.display='none';document.getElementById('resultBox').style.display='none'}
    function renderExchange(type){const list=document.getElementById('exchangeList');list.innerHTML='';const packs={DATA:[{name:'40 MB',sub:'Validity : 7 days',points:50,code:'DATA_40MB',icon:'fa-signal'},{name:'100 MB',sub:'Validity : 7 days',points:100,code:'DATA_100MB',icon:'fa-signal'},{name:'300 MB',sub:'Validity : 7 days',points:200,code:'DATA_300MB',icon:'fa-signal'},{name:'800 MB',sub:'Validity : 7 days',points:400,code:'DATA_800MB',icon:'fa-signal'},{name:'1350 MB',sub:'Validity : 7 days',points:600,code:'DATA_1350MB',icon:'fa-signal'},{name:'2000 MB',sub:'Validity : 7 days',points:800,code:'DATA_2000MB',icon:'fa-signal'},{name:'2750 MB',sub:'Validity : 7 days',points:1000,code:'DATA_2750MB',icon:'fa-signal'},{name:'22000 MB',sub:'Validity : 7 days',points:8000,code:'DATA_22000MB',icon:'fa-signal'}],VOICE:[{name:'8 MINS',sub:'Validity : 7 days',points:50,code:'VOICE_8MIN',icon:'fa-phone'},{name:'20 MINS',sub:'Validity : 7 days',points:100,code:'VOICE_20MIN',icon:'fa-phone'},{name:'60 MINS',sub:'Validity : 7 days',points:200,code:'VOICE_60MIN',icon:'fa-phone'},{name:'160 MINS',sub:'Validity : 7 days',points:400,code:'VOICE_160MIN',icon:'fa-phone'},{name:'270 MINS',sub:'Validity : 7 days',points:600,code:'VOICE_270MIN',icon:'fa-phone'},{name:'400 MINS',sub:'Validity : 7 days',points:800,code:'VOICE_400MIN',icon:'fa-phone'},{name:'550 MINS',sub:'Validity : 7 days',points:1000,code:'VOICE_550MIN',icon:'fa-phone'}],SMS:[{name:'400 SMS',sub:'Validity : 7 days',points:50,code:'SMS_400',icon:'fa-comment-dots'},{name:'1000 SMS',sub:'Validity : 7 days',points:100,code:'SMS_1000',icon:'fa-comment-dots'},{name:'3000 SMS',sub:'Validity : 7 days',points:200,code:'SMS_3000',icon:'fa-comment-dots'},{name:'8000 SMS',sub:'Validity : 7 days',points:400,code:'SMS_8000',icon:'fa-comment-dots'},{name:'13500 SMS',sub:'Validity : 7 days',points:600,code:'SMS_13500',icon:'fa-comment-dots'},{name:'20000 SMS',sub:'Validity : 7 days',points:800,code:'SMS_20000',icon:'fa-comment-dots'},{name:'27500 SMS',sub:'Validity : 7 days',points:1000,code:'SMS_27500',icon:'fa-comment-dots'}]}[type||'DATA'];packs.forEach(p=>{const card=document.createElement('div');card.className='pack-card';card.innerHTML=`<div class="pack-ic"><i class="fas ${p.icon}"></i></div><div class="pack-info"><div class="pack-name">${p.name}</div><div class="pack-sub">${p.sub}</div></div><button class="pack-price">${p.points} <small>Points</small></button>`;card.querySelector('.pack-price').addEventListener('click',()=>{openConfirm(p.code,`${p.points}Point - ${p.name}`,'7 day',`${p.points}Point`,p.name)});list.appendChild(card)})}
    async function _exchange(rewardCode){const url='https://apis.mytel.com.mm/loyalty/api/v3.1/pack/exchange';const token=localStorage.getItem('mytelToken');const accounts=JSON.parse(localStorage.getItem('mytelAccounts')||'[]');const msisdn=formatMsisdn(accounts[0]?.msisdn||'');if(!token){openResult(false,'Login token မရှိပါ');return}if(!msisdn){openResult(false,'ဖုန်းနံပါတ် မရှိပါ');return}const deviceId=(localStorage.getItem('deviceId'))||(function(){const id='web_'+Math.random().toString(36).slice(2);localStorage.setItem('deviceId',id);return id})();const body={msisdn,rewardCode,requestId:deviceId,requestTime:String(Date.now())};try{const res=await fetch(url,{method:'POST',headers:{'Authorization':`Bearer ${token}`,'access-token':token,'Accept':'application/json','Content-Type':'application/json'},body:JSON.stringify(body)});const data=await res.json().catch(()=>({}));const ok=isApiSuccess(data,res);openResult(ok,data.message|| (ok?'Exchange success':'Exchange failed'));if(ok){fetchLoyaltyPoints(token)}}catch(e){openResult(false,'Network error')}}
    function showMainApp(){const savedToken=localStorage.getItem('mytelToken');if(savedToken){document.getElementById('tokenScreen').style.display='none';document.getElementById('dataScreen').style.display='block';fetchAccountData(savedToken)}else{document.getElementById('tokenScreen').style.display='block';document.getElementById('dataScreen').style.display='none'}}
    async function encryptRSA(plaintext,publicKeyBase64){return new Promise((resolve,reject)=>{try{const publicKeyPem="-----BEGIN PUBLIC KEY-----\r\n"+publicKeyBase64+"\r\n-----END PUBLIC KEY-----";const encryptor=new JSEncrypt();encryptor.setPublicKey(publicKeyPem);const encrypted=encryptor.encrypt(plaintext);if(encrypted)resolve(encrypted);else reject(new Error("Encryption failed - possibly invalid public key"))}catch(error){reject(error)}})}
    function updateSystemStatus(message, status) {
      const a = document.getElementById('systemStatus');
      const b = document.getElementById('statusDisplay');
      const autoBtn = document.getElementById('startAutoBtn');
      const heartBtn = document.getElementById('heartToDia');
      const diaBtn = document.getElementById('diaToTurn');
      const buyBtn = document.getElementById('buy60HeartsBtn');

      if (a && b) {
        a.textContent = message;
        a.className = 'status-value';
        autoBtn.classList.remove('success');
        heartBtn.classList.remove('success');
        diaBtn.classList.remove('success');
        if (buyBtn) {buyBtn.disabled=true;buyBtn.classList.remove('success');}

        if (status === 'ready') {
          a.classList.add('status-ready');
          autoBtn.classList.add('success');
          heartBtn.classList.add('success');
          diaBtn.classList.add('success');
          if (buyBtn) {buyBtn.disabled=false;buyBtn.classList.add('success');}
        } else if (status === 'loading') {
          a.classList.add('status-loading');
        } else if (status === 'error') {
          a.classList.add('status-error');
        }

        b.style.display = 'block';
      }
    }
    function showPlayMessage(text,type){
      try { if (typeof playSound === 'function') { playSound(); } } catch(e) {}
      const el=document.getElementById('playMessage');
      if(el){
        el.textContent=text;
        el.className='message '+type;
        el.style.display='block';
        if(type==='success') setTimeout(()=>{el.style.display='none'},5000);
      }
    }
    function displayPlayerInfo(playerData){const info=document.getElementById('playerInfo');const ms=document.getElementById('playerMsisdn');const gh=document.getElementById('goldenHeart');const tt=document.getElementById('totalTurn');const rt=document.getElementById('remainTurn');const di=document.getElementById('diamond');const s=document.getElementById('startAutoBtn');const dtt=document.getElementById('diaToTurn');const htd=document.getElementById('heartToDia');const buyBtn=document.getElementById('buy60HeartsBtn');if(playerData&&playerData.result){gameState.playerInfo=playerData.result;ms.textContent=playerData.result.msisdn||'-';gh.textContent=playerData.result.goldenHeart||'0';tt.textContent=playerData.result.turn||'0';rt.textContent=playerData.result.remainTurn||'0';di.textContent=playerData.result.diamond?Number(playerData.result.diamond).toLocaleString():'0';info.style.display='block';s.disabled=false;dtt.disabled=false;htd.disabled=false;if(buyBtn)buyBtn.disabled=false;}}
    function updateStatsDisplay(){const wrap=document.getElementById('statsDisplay');const dv=document.querySelector('.stat-data .stat-value');const pv=document.querySelector('.stat-point .stat-value');const vv=document.querySelector('.stat-voice .stat-value');if(wrap&&dv&&pv&&vv){dv.innerHTML=gameState.data+'<span class="stat-unit">MB</span>';pv.innerHTML=gameState.point+'<span class="stat-unit">PTS</span>';vv.innerHTML=gameState.voice+'<span class="stat-unit">MIN</span>';document.querySelector('.stat-data').style.display=gameState.data!==0?'block':'none';document.querySelector('.stat-point').style.display=gameState.point!==0?'block':'none';document.querySelector('.stat-voice').style.display=gameState.voice!==0?'block':'none';wrap.style.display=(gameState.data||gameState.point||gameState.voice)?'grid':'none'}}
    function detectAndShowPrize(prizeCode){
      if(!prizeCode||prizeCode==='No prize')return;
      try{
        const code=prizeCode.toUpperCase();
        let match;
        const gameMode = gameState.currentGameMode || 'Unknown Mode';
        // Detect Data prizes: RD_DATA_100MB or RD_DATA100MB
        if(match=code.match(/RD_DATA[_-]?(\d+)MB/i)){
          const amount=parseInt(match[1]);
          if(amount>0){
            gameState.data+=amount;
            savePrizeToHistory('data', amount, gameMode);
            updateStatsDisplay();
            console.log('✅ Detected Data Prize:',amount,'MB');
            return;
          }
        }
        // Detect Point prizes: RD_LOYALTY_500 or RD_LOYALTY500
        if(match=code.match(/RD_LOYALTY[_-]?(\d+)/i)){
          const amount=parseInt(match[1]);
          if(amount>0){
            gameState.point+=amount;
            savePrizeToHistory('point', amount, gameMode);
            updateStatsDisplay();
            console.log('✅ Detected Point Prize:',amount,'Points');
            return;
          }
        }
        // Detect Voice prizes: RD_VOICE_30 or RD_VOICE30
        if(match=code.match(/RD_VOICE[_-]?(\d+)/i)){
          const amount=parseInt(match[1]);
          if(amount>0){
            gameState.voice+=amount;
            savePrizeToHistory('voice', amount, gameMode);
            updateStatsDisplay();
            console.log('✅ Detected Voice Prize:',amount,'Minutes');
            return;
          }
        }
        console.log('ℹ️ No prize detected from code:',prizeCode);
      }catch(e){
        console.error('❌ Error in detectAndShowPrize:',e);
      }
    }
    function processEndGamePrizes(list) {
        if (!list || !Array.isArray(list)) return;
        let td = 0, tp = 0, tv = 0;
        const gameMode = gameState.currentGameMode || 'Unknown Mode';
        
        list.forEach(p => {
            const c = p.prizeCode;
            const a = p.amount || 0;
            if (c.includes('RD_DATA')) td += a;
            else if (c.includes('RD_LOYALTY')) tp += a;
            else if (c.includes('RD_VOICE')) tv += a;
        });
        
        if (td > 0) {
            gameState.data += td;
            addGameLog(`<img class="prize-ic" src="${localOrRemote('ic_data.png')}"> Total Data Amount: ${td}MB`, 'success');
            savePrizeToHistory('data', td, gameMode);
        }
        if (tp > 0) {
            gameState.point += tp;
            addGameLog(`<img class="prize-ic" src="${localOrRemote('ic_point.png')}"> Total Point Amount: ${tp}PTS`, 'success');
            savePrizeToHistory('point', tp, gameMode);
        }
        if (tv > 0) {
            gameState.voice += tv;
            addGameLog(`<img class="prize-ic" src="${localOrRemote('ic_voice.png')}"> Total Voice Amount: ${tv}MIN`, 'success');
            savePrizeToHistory('voice', tv, gameMode);
        }
        updateStatsDisplay();
    }
    function addGameLog(msg, type = 'info') {
      // Hide certain backend error codes from user-facing Game Log
      try {
        if (typeof msg === 'string') {
          // Hide E10400: insufficient balance
          if (/\bE10400\b/i.test(msg)) {
            msg = msg.replace(/\bE10400\b\s*\|\s*/i, '');
            msg = msg.replace(/You don't have enough money/i, 'ငွေမလုံလောက်ပါ');
          }
        }
      } catch (_) {}

      try {
        if (typeof msg === 'string' && msg.includes('CAN_NOT_PLAY_WORLD_MODE')) {
          msg = 'World Mode ဆော့လို့မရပါ Diamond 2 သောင်းတန်လက်အိပ်အရင်ဝယ်ပါ';
          type = 'error';
          try { if (typeof window !== 'undefined') { stopAutoGame(); } } catch(_) {}
        }
      } catch (_) {}

      const c = document.getElementById('logContent');
      const g = document.getElementById('gameLog');
      if (c && g) {
        const i = document.createElement('div');
        i.className = `log-item log-${type}`;
        i.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}`;
        c.appendChild(i);
        c.scrollTop = c.scrollHeight;
        g.style.display = 'block';
        setTimeout(() => {
          i.style.animation = 'highlight .5s ease';
          setTimeout(() => { i.style.animation = '' }, 500);
        }, 10);
      }
    }
    function clearGameLog(){const c=document.getElementById('logContent');if(c)c.innerHTML=''}
    
    // Heart to Diamond function
    async function heartToDiamond(times){
        if(!gameState.isAutoRunning){
            const btn = document.getElementById('heartToDia');
            btn.classList.add('loading');
            btn.disabled = true;
            try{
                let n = parseInt(times || 1, 10);
                if (!Number.isFinite(n) || n < 1) n = 1;
                if (n > 50) n = 50;
                const sleep = (ms)=>new Promise(res=>setTimeout(res, ms));

                let ok = 0, fail = 0;
                for (let i=0; i<n; i++){
                    try{
                        const start = await (window.apis?.startQuestMode && window.apis.startQuestMode('GOLDEN_HEART'));
                        if(start && start.result){
                            const s = start.result;
                            const sid = (s.gameId || s.sessionId);
                            const data = s.t1 + "_@@_" + sid + "_@@_" + 5 + "_@@_" + s.msisdn;
                            const encrypted = await encryptRSA(data, s.t2);
                            const endRes = await (window.apis?.endGameQuestMode && window.apis.endGameQuestMode(encrypted, 5, 100));
                            if(endRes && endRes.message){
                                ok++;
                                addGameLog(`Pack ${i+1}/${n}: အသဲ 6 → စိန် 1500 အောင်မြင်`, 'success');
                                try{ if(typeof window.getPlayerInfo === 'function') await window.getPlayerInfo(); }catch(_){}
                            }else{
                                fail++;
                                addGameLog(`Pack ${i+1}/${n}: endGameQuestMode failed`, 'error');
                            }
                        }else{
                            fail++;
                            addGameLog(`Pack ${i+1}/${n}: မအောင်မြင်ပါ...`, 'error');
                        }
                    }catch(e){
                        fail++;
                        addGameLog(`Pack ${i+1}/${n}: error ${e}`, 'error');
                    }
                    if(i < n-1) await sleep(1200);
                }
                addGameLog(`Total: Success ${ok}, Failed ${fail}`, fail ? 'error' : 'success');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }else{
            addGameLog('stop auto play first.', 'info');
        }
    }

    // Buy Heart Package function
    async function buyHeartPackage(){
        try{
            if(!(window.apis && typeof window.apis.buyPackage === 'function')){
                if (typeof addGameLog === 'function') addGameLog('Buy Package API is not available.', 'error');
                else alert('Buy Package API is not available.');
                return;
            }
            const btn = document.getElementById('buy60HeartsBtn');
            if (btn){ btn.disabled = true; btn.classList.add('loading'); }

            if (typeof addGameLog === 'function') addGameLog('အသဲ 60 ခု ဝယ်ယူနေသည်...', 'info');

            const result = await window.apis.buyPackage("LOVE_PACK");

            if (result && (result.success || result.ok)){
                if (typeof addGameLog === 'function') addGameLog('အသဲ 60 ဝယ်ယူခြင်း အောင်မြင်ပါသည်', 'success');
                if (window.apis && typeof window.apis.getPlayerInfo === 'function'){
                    try{
                        const info = await window.apis.getPlayerInfo();
                        if (typeof displayPlayerInfo === 'function') displayPlayerInfo(info);
                    }catch(e){}
                }
            }else{
                const msg = (result && (result.message||result.error)) ? String(result.message||result.error) : 'Failed to buy heart package';
                if (typeof addGameLog === 'function') addGameLog('' + msg, 'error');
                else alert(msg);
            }
        }catch(err){
            if (typeof addGameLog === 'function') addGameLog('Failed To Buy Heart: ' + (err && err.message ? err.message : err), 'error');
        }finally{
            const btn = document.getElementById('buy60HeartsBtn');
            if (btn){ btn.disabled = false; btn.classList.remove('loading'); }
        }
    }

    // Diamond to Turn Exchange Dialog Functionality
    (function(){
      const stepDiamond = 200;
      const stepTurn = 5;
      let unitCount = 1;

      const el = {
        overlay: document.getElementById('dttOverlay'),
        box: document.getElementById('dttBox'),
        plus: null, minus: null, exchange: null,
        d: null, t: null, dChip: null, tChip: null,
        count: null,
        trigger: document.getElementById('diaToTurn')
      };

      function syncDisplay(){
        const d = unitCount * stepDiamond;
        const t = unitCount * stepTurn;
        if (el.d) el.d.textContent = d;
        if (el.t) el.t.textContent = t;
        if (el.dChip) el.dChip.textContent = d;
        if (el.tChip) el.tChip.textContent = t;
        if (el.count) el.count.textContent = unitCount;
      }

      function openDTTDialog(){
        unitCount = 1;
        syncDisplay();
        if (el.overlay) el.overlay.style.display = 'block';
        if (el.box) el.box.style.display = 'block';
      }
      function closeDTTDialog(){
        if (el.overlay) el.overlay.style.display = 'none';
        if (el.box) el.box.style.display = 'none';
      }

      async function performExchange(){
        const calls = unitCount;
        const btn = el.exchange;
        if (!btn) return;
        
        btn.classList.add('loading');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        try {
          for (let i = 0; i < calls; i++){
            if (typeof window.apis?.buyTurn !== 'function'){
              addGameLog('buyTurn API not available','error');
              break;
            }
            const r = await window.apis.buyTurn();
            if (r && r.success === true){
              addGameLog(`Exchange ${i+1}/${calls}: ${r.message || 'OK'}`,'success');
            } else {
              const msg = (r && (r.error?.message || r.message)) || 'Unknown error';
              addGameLog(`Exchange ${i+1}/${calls} failed: ${msg}`,'error');
              break;
            }
          }
          if (typeof window.getPlayerInfo === 'function') window.getPlayerInfo();
        } catch(e){
          addGameLog(`Exchange error: ${e.message}`,'error');
        } finally {
          btn.classList.remove('loading');
          btn.innerHTML = '<i class="fas fa-right-left"></i> Exchange';
          closeDTTDialog();
        }
      }

      document.addEventListener('DOMContentLoaded', function(){
        el.plus = document.getElementById('dttPlus');
        el.minus = document.getElementById('dttMinus');
        el.exchange = document.getElementById('dttExchange');
        el.d = document.getElementById('dttDiamond');
        el.t = document.getElementById('dttTurns');
        el.dChip = document.getElementById('dttDiamondChip');
        el.tChip = document.getElementById('dttTurnsChip');
        el.count = document.getElementById('dttCount');

        try {
          if (el.trigger) el.trigger.replaceWith(el.trigger.cloneNode(true));
        } catch(_) {}
        const newTrigger = document.getElementById('diaToTurn');
        if (newTrigger){
          newTrigger.addEventListener('click', function(){
            if (this.disabled) return;
            openDTTDialog();
          });
        }

        if (el.plus) el.plus.addEventListener('click', function(){ unitCount++; syncDisplay(); });
        if (el.minus) el.minus.addEventListener('click', function(){
          if (unitCount > 1){ unitCount--; syncDisplay(); }
        });
        if (el.exchange) el.exchange.addEventListener('click', performExchange);

        if (el.overlay) el.overlay.addEventListener('click', closeDTTDialog);
      });
    })();

    // Heart to Diamond Exchange Dialog Functionality
    (function(){
      const HEARTS_PER_PACK = 6, DIAMS_PER_PACK = 1500;
      const openBtn = document.getElementById('heartToDia');
      if (!openBtn) return;

      const clone = openBtn.cloneNode(true);
      clone.removeAttribute('onclick');
      openBtn.parentNode.replaceChild(clone, openBtn);

      const overlay = document.getElementById('htdOverlay');
      const box = document.getElementById('htdBox');
      const minus = document.getElementById('htdMinus');
      const plus  = document.getElementById('htdPlus');
      const count = document.getElementById('htdCount');
      const heartsEl = document.getElementById('htdHearts');
      const diamsEl  = document.getElementById('htdDiams');
      const exchange = document.getElementById('htdExchange');
      let qty = 1;

      function render(){
        if (count) count.textContent = qty;
        if (heartsEl) heartsEl.textContent = (HEARTS_PER_PACK * qty).toLocaleString();
        if (diamsEl) diamsEl.textContent  = (DIAMS_PER_PACK * qty).toLocaleString();
      }

      function openDlg(e){
        try { e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation(); } catch(_){}
        qty = 1;
        render();
        if (overlay) overlay.style.display = 'block';
        if (box) box.style.display = 'block';
        return false;
      }
      function closeDlg(){
        if (overlay) overlay.style.display = 'none';
        if (box) box.style.display = 'none';
      }

      function getAvailableHearts(){
        let have = 0;
        try{
          if (window.gameState) {
            const g = window.gameState;
            have = Number(g.heart ?? g.hearts ?? g.player?.heart ?? g.player?.hearts ?? 0);
          }
          if (!have) {
            const el = document.querySelector('#statHeart, #statHearts, .stat-heart .value, [data-stat="heart"]');
            if (el) have = Number((el.textContent||'').replace(/[^0-9]/g,'')) || 0;
          }
        }catch(_){}
        return have || 0;
      }

      clone.addEventListener('click', openDlg, true);
      clone.addEventListener('click', openDlg, false);
      if (overlay) overlay.addEventListener('click', closeDlg);
      if (minus) minus.addEventListener('click', function(){ if (qty>1){ qty--; render(); } });
      if (plus) plus.addEventListener('click',  function(){ if (qty<9999){ qty++; render(); } });

      if (exchange) {
        exchange.addEventListener('click', async function(){
          const need = HEARTS_PER_PACK * qty;
          try{ if (typeof window.getPlayerInfo === 'function') { await window.getPlayerInfo(); } }catch(_){}
          closeDlg();
          if (typeof window.heartToDiamond === 'function') {
            try { await window.heartToDiamond(qty); } catch(e){ console.error(e); }
          }
        });
      }
    })();

    async function buyTurn(){if(!gameState.isAutoRunning){const b=document.getElementById('diaToTurn');b.classList.add('loading');b.disabled=true;try{const r=await window.apis?.buyTurn();b.classList.remove('loading');b.disabled=false;if(r.success===true){window.getPlayerInfo();if(r.message){addGameLog(`${r.message}`,'success');addGameLog(`Diamond > ${r.result.diamond}`,'success');addGameLog(`Turn > ${r.result.amountTurn}`,'success')}else{addGameLog(`No response`,'error')}}else{addGameLog(`${r.error.message}`,'error')}}catch(e){addGameLog(`buy turn error: ${e}`,'error');b.classList.remove('loading');b.disabled=false}}else{addGameLog('stop auto play first.','info');const b=document.getElementById('diaToTurn');b.classList.remove('loading');b.disabled=false}}
    
    // ========== NEW GAME MODE FUNCTIONS ==========

    // Helper functions from play.js
    function getScore(wave) {
        return 14366 * wave;
    }

    function rsaPayloadEncrypt(t1, t2, parts) {
        const payload = parts.join('_@@_');
        return encryptRSA(payload, t2);
    }

    // Normal Mode Game Functions
    async function normalCreateGame() {
        gameState.currentGameMode = 'Normal Mode';
        addGameLog('Creating NORMAL game...','info');
        try {
            gameState.bossId = null;
            const result = await window.apis?.createGame('NORMAL','LUCUS');
            if (result && result.success) {
                gameState.sessionId = result.result.sessionId;
                gameState.msisdn   = result.result.msisdn;
                gameState.t1       = result.result.t1;
                gameState.t2       = result.result.t2;
                gameState.wave     = 0;
                gameState.score    = 0;
                addGameLog('NORMAL game created successfully.','success');
                return true;
            }
            throw new Error(result && result.message ? String(result.message) : 'Unknown error');
        } catch (e) {
            addGameLog(`Create game error: ${e.message}`,'error');
            throw e;
        }
    }

    async function normalNextWave(wave) {
        try {
            const ii = wave + 200;
            const waveScore = getScore(10 * ii + 500);
            const result = await window.apis?.nextWave(waveScore, 'NORMAL');
            if (result && result.success && result.result && Array.isArray(result.result.bossIds) && result.result.bossIds.length > 0) {
                gameState.bossId = result.result.bossIds[0];
                return true;
            }
            throw new Error('No boss IDs returned from server');
        } catch (e) {
            addGameLog(`Next wave error: ${e.message}`,'error');
            gameState.sessionId = null;
            throw e;
        }
    }

    async function normalKillBoss(wave) {
        if (!gameState.bossId) {
            addGameLog('Invalid boss ID, recreating game...','error');
            gameState.sessionId = null;
            return false;
        }
        const killScore = getScore(2 * wave + 1);
        const U = `${gameState.t1}_@@_${gameState.sessionId}_@@_${gameState.msisdn}_@@_${killScore}_@@_${gameState.t1}`;
        try {
            const j   = await encryptRSA(U, gameState.t2);
            const bid = Array.isArray(gameState.bossId) ? gameState.bossId[0] : gameState.bossId;
            const ds  = (2 * killScore).toString();
            const result = await window.apis?.killBoss(j, ds, bid, 'NORMAL');
            if (result && result.success) {
                const prizeCode = (result.result && result.result.prizeCode) ? result.result.prizeCode : 'No prize';
                const processed = simplePrizeProcessor(prizeCode);
                addGameLog(`Wave ${wave} Prize: ${processed}`,'success');
                try { if (typeof detectAndShowPrize === 'function') detectAndShowPrize(prizeCode); } catch(_){}
                return true;
            }
            if (result && result.message && result.message.includes('Session ID is not OK')) {
                stopAutoGame();
                showPlayMessage(' Auto Play ကိုပြန်နှိပ်ပါ','error');
                return false;
            }
            return false;
        } catch (e) {
            addGameLog(`Kill boss failed: ${e.message}`,'error');
            return false;
        }
    }

    async function normalEndGame() {
        const gold = 3000000;
        const fgold = String(3 * gold);
        const scoreEnd = getScore(14);
        const fiscore = String(4 * scoreEnd);
        const payload2 = `${gameState.t1}_@@_0_@@_${gold}_@@_${gameState.msisdn}_@@_${scoreEnd}_@@_1`;
        const encpayload2 = await encryptRSA(payload2, gameState.t2);
        const endRes = await window.apis?.createEndGame(encpayload2, fiscore, fgold);
        return endRes;
    }

    async function normalGameLoop() {
        let consecutiveErrors = 0;
        const MAX_ERRORS = 3;
        while (gameState.isAutoRunning) {
            try {
                consecutiveErrors = 0;
                await normalCreateGame();
                if (!gameState.isAutoRunning) break;
                for (let wave = 0; wave < 9 && gameState.isAutoRunning; wave++) {
                    try {
                        await normalNextWave(wave);
                        await normalKillBoss(wave);
                    } catch (waveErr) {
                        addGameLog(`Wave ${wave} error: ${waveErr.message}`,'error');
                    }
                }
                if (gameState.wave >= 9) {
                    try {
                        const endRes = await normalEndGame();
                        if (endRes && endRes.success && endRes.result && endRes.result.claimedPrizes) {
                            processEndGamePrizes(endRes.result.claimedPrizes);
                            addGameLog('NORMAL Game completed successfully.','success');
                        }
                    } catch (endErr) {
                        addGameLog(`End game error: ${endErr.message}`,'error');
                    }
                    gameState.wave  = 0;
                    gameState.score = 0;
                }
            } catch (loopErr) {
                consecutiveErrors++;
                addGameLog(`Game loop error: ${loopErr.message}`,'error');
                if (consecutiveErrors >= MAX_ERRORS) {
                    addGameLog('Too many consecutive errors, stopping auto game','error');
                    stopAutoGame();
                    break;
                }
                const waitTime = 2000 * consecutiveErrors;
                await new Promise(res => setTimeout(res, waitTime));
            }
        }
    }

    // Quest Mode Game Functions
    async function questCreateGame() {
        gameState.currentGameMode = 'Quest Mode';
        addGameLog('Creating QUEST game...','info');
        try {
            gameState.bossId = null;
            const result = await window.apis?.buyTicketCreateGame('GOLDEN_HEART');
            if (result && result.success) {
                gameState.sessionId = result.result.sessionId || result.result.gameId;
                gameState.msisdn   = result.result.msisdn;
                gameState.t1       = result.result.t1;
                gameState.t2       = result.result.t2;
                gameState.wave     = 0;
                gameState.score    = 0;
                addGameLog('QUEST game created successfully.','success');
                return true;
            }
            throw new Error(result && result.message ? String(result.message) : 'Unknown error');
        } catch (e) {
            addGameLog(`Create game error: ${e.message}`,'error');
            throw e;
        }
    }

    async function questKillBoss(wave) {
        if (!gameState.sessionId || !gameState.t1 || !gameState.t2 || !gameState.msisdn) {
            addGameLog('Missing game state for QUEST mode','error');
            return false;
        }
        const encpayload2 = await encryptRSA(`${gameState.t1}_@@_${gameState.sessionId}_@@_${gameState.msisdn}`, gameState.t2);
        try {
            const result = await window.apis?.killBossBounceQuestE(encpayload2);
            const ok = result?.success === true;
            if (ok) {
                const prizeCode = (result.result && result.result.prizeCode) ? result.result.prizeCode : 'No prize';
                const processed = simplePrizeProcessor(prizeCode);
                addGameLog(`Turn ${wave} Prize: ${processed}`,'success');
                try { if (typeof detectAndShowPrize === 'function') detectAndShowPrize(prizeCode); } catch(_){}
            }
            // Check for stop condition
            const code = String(result?.code || '');
            if (code === 'OVER_AMOUNT_PRIZE_PER_TURN') {
                return 'COMPLETED';
            }
            return ok ? 'CONTINUE' : 'ERROR';
        } catch (e) {
            addGameLog(`Quest kill boss error: ${e.message}`,'error');
            return 'ERROR';
        }
    }

    async function questEndGame() {
        const bigDamage = 70;
        const encpayload3 = await encryptRSA(`${gameState.t1}_@@_${gameState.sessionId}_@@_${bigDamage}_@@_${gameState.msisdn}`, gameState.t2);
        const endRes = await window.apis?.endGameBounceQuestNb(encpayload3, String(bigDamage));
        return endRes;
    }

    async function questGameLoop() {
        let consecutiveErrors = 0;
        const MAX_ERRORS = 3;
        while (gameState.isAutoRunning) {
            try {
                consecutiveErrors = 0;
                await questCreateGame();
                if (!gameState.isAutoRunning) break;
                let wave = 0;
                let result;
                for (; wave < 70 && gameState.isAutoRunning; wave++) {
                    try {
                        result = await questKillBoss(wave);
                        if (result === 'COMPLETED') {
                            break;
                        } else if (result === 'ERROR') {
                            // Maybe break on too many errors?
                        }
                    } catch (waveErr) {
                        addGameLog(`Turn ${wave} error: ${waveErr.message}`,'error');
                    }
                }
                try {
                    const endRes = await questEndGame();
                    if (endRes && endRes.success) {
                        const res = endRes.result || endRes;
                        const turns = Number(res?.numTurn ?? 0) || 0;
                        const rank = res?.rank != null ? String(res.rank) : '';
                        const header = `🏁 Quest finished` + (turns ? `\n- Turns: ${turns}` : '') + (rank ? `\n- Rank: ${rank}` : '');
                        addGameLog(header, 'success');
                        // Also, if there are prizes in the end game, process them?
                        if (res.prizes) {
                            processEndGamePrizes(res.prizes);
                        }
                    }
                } catch (endErr) {
                    addGameLog(`End game error: ${endErr.message}`,'error');
                }
                gameState.wave  = 0;
                gameState.score = 0;
            } catch (loopErr) {
                consecutiveErrors++;
                addGameLog(`Game loop error: ${loopErr.message}`,'error');
                if (consecutiveErrors >= MAX_ERRORS) {
                    addGameLog('Too many consecutive errors, stopping auto game','error');
                    stopAutoGame();
                    break;
                }
                const waitTime = 2000 * consecutiveErrors;
                await new Promise(res => setTimeout(res, waitTime));
            }
        }
    }

    // Updated startAutoGame function with button state management
    async function startAutoGame(){
        // Determine which game mode to run based on the user's selection
        const modeSelector = document.getElementById('gameMode');
        const selectedMode = modeSelector ? modeSelector.value : 'WORLD';
        
        if(!gameState.isAutoRunning){
            gameState.isAutoRunning=true;
            gameState.wave=0;
            gameState.score=0;
            updateAutoButtonState(true);
            
            if (selectedMode === 'HERO') {
                addGameLog('HERO Mode auto game started','info');
                heroGameLoop();
            } else if (selectedMode === 'NORMAL') {
                addGameLog('NORMAL Mode auto game started','info');
                normalGameLoop();
            } else if (selectedMode === 'QUEST') {
                addGameLog('QUEST Mode auto game started','info');
                questGameLoop();
            } else {
                addGameLog('WORLD Mode auto game started','info');
                // Use the existing WORLD game loop for legacy mode
                gameLoop();
            }
        }else{
            stopAutoGame();
        }
    }
    
    // Helper function to get display name from mode value
    function getModeDisplayName(modeValue) {
        switch(modeValue) {
            case 'HERO': return 'Hero Mode';
            case 'NORMAL': return 'Normal Mode';
            case 'QUEST': return 'Quest Mode';
            case 'WORLD': return 'World Mode';
            default: return 'Unknown Mode';
        }
    }

    // Updated stopAutoGame function with button state management  
    function stopAutoGame(){
        const currentMode = gameState.currentGameMode;
        gameState.isAutoRunning=false;
        updateAutoButtonState(false);
        addGameLog(`${currentMode || 'Game'} Stopped`,'info');
        // Don't reset currentGameMode here - it will be set when starting new mode
    }

    // Global updateAutoButtonState function
    function updateAutoButtonState(isRunning) {
        const btn = document.getElementById('startAutoBtn');
        const modeSelector = document.getElementById('gameMode');
        
        if (!btn) return;
        
        if (isRunning) {
            btn.innerHTML = '<i class="fas fa-stop"></i> ရပ်မယ်';
            btn.classList.add('auto-btn-stop');
            // Disable mode selector when game is running
            if (modeSelector) modeSelector.disabled = true;
        } else {
            // Get selected mode name for button text
            const selectedMode = modeSelector ? modeSelector.value : 'WORLD';
            const modeText = getModeDisplayName(selectedMode);
            btn.innerHTML = `<i class="fas fa-play"></i> ကစားမယ် (${modeText})`;
            btn.classList.remove('auto-btn-stop');
            // Enable mode selector when game is stopped
            if (modeSelector) modeSelector.disabled = false;
        }
    }

    async function gameLoop(){let ce=0;const MAX=3;while(gameState.isAutoRunning){try{ce=0;await createGame();if(!gameState.isAutoRunning)break;while(gameState.wave<19&&gameState.isAutoRunning){try{await nextWave()}catch(w){addGameLog(`Wave ${gameState.wave} error: ${w.message}`,'error')}gameState.wave++;try{await killBoss()}catch(k){if(Object.keys(k).length===0)addGameLog(`Wave ${gameState.wave} Killboss Error.`,'error');else addGameLog(`Wave ${gameState.wave} Killboss Error: ${k.message}`,'error')}}if(gameState.wave>=19){try{var n=gameState.t1,o=gameState.t2,r=gameState.msisdn,i=o,f=Math.floor(gameState.score);l=n,h="984271",g="1243";var v=l+"_@@_0_@@_"+h+"_@@_"+r+"_@@_"+f+"_@@_"+g;const b=await encryptRSA(v,i);const ds=(4*gameState.score).toString();const th=(3*parseInt(h)).toString();addGameLog('End game','info');const end=await window.apis?.createEndGame(b,ds,th);if(end&&end.success&&end.result&&end.result.claimedPrizes){processEndGamePrizes(end.result.claimedPrizes);addGameLog('Game Completed Successfully.','success')}else{addGameLog('Game Completed But No Prizes received','info')}}catch(e){if(e.message&&e.message.includes('timeout'))addGameLog('End Game Request Timeout','error');else addGameLog(`End Game Error: ${e.message}`,'error')}gameState.wave=0;gameState.score=0}}catch(e){ce++;addGameLog(`Game Loop Error: ${e.message}`,'error');if(ce>=MAX){addGameLog(`Too many consecutive errors (${ce}), stopping auto game`,'error');stopAutoGame();break}const wait=2000*ce;addGameLog(`Waiting ${wait/1000} seconds before retry...`,'info');await new Promise(r=>setTimeout(r,wait))}}}
    async function createGame(){
        gameState.currentGameMode = 'World Mode';
        addGameLog('Creating New Game...','info');
        try{
            gameState.bossId=null;
            const r=await window.apis?.createGame("WORLD","LUCUS")||{success:true,result:{sessionId:'session_'+Date.now(),msisdn:gameState.msisdn||'09666666666',t1:'t1_'+Math.random().toString(36).substring(2),t2:'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA'+Math.random().toString(36).substring(2)}};
            if(r.success){
                gameState.sessionId=r.result.sessionId;
                gameState.msisdn=r.result.msisdn;
                gameState.t1=r.result.t1;
                gameState.t2=r.result.t2;
                gameState.wave=0;
                gameState.score=0;
                addGameLog('Created Game Successfully.','success');
                return true;
            }else{
                throw new Error(`Create Game Failed: ${r.message}`);
            }
        }catch(e){
            addGameLog(`Create Game Error: ${e.message}`,'error');
            throw e;
        }
    }
    async function nextWave(){try{const r=await window.apis?.nextWave(gameState.wave.toString(),"WORLD")||{success:true,result:{bossIds:['boss_'+Math.random().toString(36).substring(2)]}};if(r.success){if(r.result.bossIds&&r.result.bossIds.length>0){gameState.bossId=r.result.bossIds[0];return true}else{throw new Error('No boss IDs returned from server')}}else{throw new Error(`Next wave failed: ${r.message}`)}}catch(e){addGameLog(`Next wave error: ${e.message}`,'error');gameState.sessionId=null;throw e}}
    async function killBoss(){if(!gameState.bossId||gameState.bossId.trim()===''){addGameLog('Invalid boss ID, recreating game...','error');gameState.sessionId=null;return false}if(!gameState.t1||!gameState.t2||!gameState.sessionId||!gameState.msisdn){addGameLog('Missing Required Game State Parameters','error');return false}if(gameState.wave===0)gameState.score=577;else gameState.score+=9800;const U=`${gameState.t1}_@@_${gameState.sessionId}_@@_${gameState.msisdn}_@@_${gameState.score}_@@_${gameState.t1}`;try{const j=await encryptRSA(U,gameState.t2);const bid=Array.isArray(gameState.bossId)?gameState.bossId[0]:gameState.bossId;const ds=(2*gameState.score).toString();const r=await window.apis?.killBoss(j,ds,bid,"WORLD")||{success:true,result:{prizeCode:'RD_DATA_100MB'}};if(r.success){const pc=r.result.prizeCode?r.result.prizeCode:'No prize';let pp=simplePrizeProcessor(pc);pp = pp.replace(/\b(MB|Points|Minutes|Stars|Diamonds|SIM)\s*-\s*/g,'$1 ');addGameLog(`Wave ${gameState.wave} Prize: ${pp}`,'success');detectAndShowPrize(pc);return true}else{if(r.message&&(r.message.includes('Session ID is not OK')||r.message.includes('invalid response was received from'))){stopAutoGame();showPlayMessage('Game ကိုပြန်လည်စတင်ပါ','error');return false}else{return false}}}catch(e){addGameLog(`Kill boss failed: ${e.message}`,'error');return false}}


    /*
     * HERO mode game logic
     *
     * These helper functions mirror the implementations found in hero.html.
     * They encapsulate the behaviour of starting a HERO game, progressing through
     * waves, defeating bosses and finalising the session.  The existing WORLD
     * functions remain untouched, allowing both modes to coexist if needed.
     */
    async function heroCreateGame() {
        gameState.currentGameMode = 'Hero Mode';
        addGameLog('Creating HERO game...','info');
        try {
            gameState.bossId = null;
            const result = await window.apis?.createGame('HERO','LUCUS');
            if (result && result.success) {
                gameState.sessionId = result.result.sessionId;
                gameState.msisdn   = result.result.msisdn;
                gameState.t1       = result.result.t1;
                gameState.t2       = result.result.t2;
                gameState.wave     = 0;
                // initialise score to the HERO base value
                gameState.score    = HERO_CONFIG.baseScore;
                addGameLog('HERO game created successfully.','success');
                return true;
            }
            throw new Error(result && result.message ? String(result.message) : 'Unknown error');
        } catch (e) {
            addGameLog(`Create game error: ${e.message}`,'error');
            throw e;
        }
    }

    async function heroNextWave() {
        try {
            // update score based on whether this is the first wave or a later one
            gameState.score = (gameState.wave === 0) ? HERO_CONFIG.baseScore : gameState.score * HERO_CONFIG.scoreMultiplier;
            const result = await window.apis?.nextWave(gameState.score.toString(),'HERO');
            if (result && result.success && result.result && Array.isArray(result.result.bossIds) && result.result.bossIds.length > 0) {
                gameState.bossId = result.result.bossIds[0];
                return true;
            }
            throw new Error('No boss IDs returned from server');
        } catch (e) {
            addGameLog(`Next wave error: ${e.message}`,'error');
            gameState.sessionId = null;
            throw e;
        }
    }

    async function heroKillBoss() {
        if (!gameState.bossId) {
            addGameLog('Invalid boss ID, recreating game...','error');
            gameState.sessionId = null;
            return false;
        }
        const U = `${gameState.t1}_@@_${gameState.sessionId}_@@_${gameState.msisdn}_@@_${gameState.score}_@@_${gameState.t1}`;
        try {
            const j   = await encryptRSA(U, gameState.t2);
            const bid = Array.isArray(gameState.bossId) ? gameState.bossId[0] : gameState.bossId;
            const ds  = (2 * gameState.score).toString();
            const result = await window.apis?.killBoss(j, ds, bid, 'HERO');
            if (result && result.success) {
                const prizeCode = (result.result && result.result.prizeCode) ? result.result.prizeCode : 'No prize';
                const processed = simplePrizeProcessor(prizeCode);
                addGameLog(`Wave ${gameState.wave} Prize: ${processed}`,'success');
                // show prize via existing helper if available
                try { if (typeof detectAndShowPrize === 'function') detectAndShowPrize(prizeCode); } catch(_){}
                return true;
            }
            if (result && result.message && result.message.includes('Session ID is not OK')) {
                stopAutoGame();
                showPlayMessage(' Auto Play ကိုပြန်နှိပ်ပါ','error');
                return false;
            }
            return false;
        } catch (e) {
            addGameLog(`Kill boss failed: ${e.message}`,'error');
            return false;
        }
    }

    async function heroEndGame() {
        const encData = await encryptRSA(`${gameState.t1}_@@_0_@@_984271_@@_${gameState.msisdn}_@@_${Math.floor(gameState.score)}_@@_1243`, gameState.t2);
        return await window.apis?.createEndGame(encData, (4 * gameState.score).toString(), (3 * 984271).toString());
    }

    async function heroGameLoop() {
        let consecutiveErrors = 0;
        const MAX_ERRORS = 3;
        while (gameState.isAutoRunning) {
            try {
                consecutiveErrors = 0;
                await heroCreateGame();
                if (!gameState.isAutoRunning) break;
                for (let wave = 1; wave <= HERO_CONFIG.maxWaves && gameState.isAutoRunning; wave++) {
                    try {
                        await heroNextWave();
                        gameState.wave = wave;
                        await heroKillBoss();
                    } catch (waveErr) {
                        addGameLog(`Wave ${wave} error: ${waveErr.message}`,'error');
                    }
                }
                if (gameState.wave >= HERO_CONFIG.maxWaves) {
                    try {
                        const endRes = await heroEndGame();
                        if (endRes && endRes.success && endRes.result && endRes.result.claimedPrizes) {
                            processEndGamePrizes(endRes.result.claimedPrizes);
                            addGameLog('HERO Game completed successfully.','success');
                        }
                    } catch (endErr) {
                        addGameLog(`End game error: ${endErr.message}`,'error');
                    }
                    // reset for next loop
                    gameState.wave  = 0;
                    gameState.score = 0;
                }
            } catch (loopErr) {
                consecutiveErrors++;
                addGameLog(`Game loop error: ${loopErr.message}`,'error');
                if (consecutiveErrors >= MAX_ERRORS) {
                    addGameLog('Too many consecutive errors, stopping auto game','error');
                    stopAutoGame();
                    break;
                }
                const waitTime = 2000 * consecutiveErrors;
                await new Promise(res => setTimeout(res, waitTime));
            }
        }
    }

    // Updated systemReady function to handle missing APIs
    window.systemReady=function(){
        if(window.apis){
            // Add any missing APIs
            addMissingApis();
            
            updateSystemStatus('System is ready!','ready');
            const ps=document.getElementById('playScreen');
            ps.classList.add('play-screen-ready');
            
            // Enable buttons only if the required APIs are available
            document.getElementById('startAutoBtn').disabled = !window.apis.createGame;
            document.getElementById('diaToTurn').disabled = !window.apis.buyTurn;
            document.getElementById('heartToDia').disabled = !window.apis.buyDiamond;
            document.getElementById('buy60HeartsBtn').disabled = !window.apis.buyPackage;
            
            if(typeof window.apis!=='undefined'){
                window.changeLanguage();
                window.getPlayerInfo();
            }else{
                showPlayMessage('Window Api Undefined','error');
            }
        }else{
            updateSystemStatus('Failed to initialize system','error');
            showPlayMessage('Failed To Initialize Api','error');
        }
    }

    window.changeLanguage=function(){setTimeout(()=>{if(window.apis&&typeof window.apis.setLanguage==='function'){window.apis.setLanguage('my').catch(()=>{})}},500)}
    window.getPlayerInfo=function(){setTimeout(()=>{if(window.apis&&typeof window.apis.getPlayerInfo==='function'){window.apis.getPlayerInfo().then(r=>{displayPlayerInfo(r)}).catch(e=>{showPlayMessage('Error Getting Player Info: '+e.message,'error');updateSystemStatus('Failed to load player data','error')})}else{const mock={result:{msisdn:document.getElementById('phoneNumber').value||'09666666666',goldenHeart:Math.floor(Math.random()*1000),turn:50,remainTurn:25,diamond:Math.floor(Math.random()*5000)}};displayPlayerInfo(mock)}},100)}
    function autoInitOnPlay(){const token=localStorage.getItem('mytelToken');const phone=(document.getElementById('phoneNumber')?.value||'').trim();if(!token){showPlayMessage('No Authentication Token. Please login again.','error');return}if(!phone){showPlayMessage('Please Enter Phone Number','error');return}updateSystemStatus('Initializing system...','loading');fetchMyIDToken(token,phone)}
    async function fetchLoyaltyPoints(token){
      try{
        const res=await fetch('https://apis.mytel.com.mm/csm/v1.0/api/loyalty',{
          method:'GET',
          headers:{'Authorization':`Bearer ${token}`,'access-token':token,'accept':'application/json'}
        });
        const data=await res.json();
        let pts='0';
        if(data&&data.errorCode===0&&data.result&&Array.isArray(data.result.balances)){
          const telco=data.result.balances.find(b=>b.loyaltyBalanceCode==='TELCO_EXCHANGEABLE_POINTS');
          if(telco&&typeof telco.balance!=='undefined'){
            pts=String(telco.balance);
          }
        }
        const nameEl=document.getElementById('pointName');
        const amountEl=document.getElementById('pointAmount');
        const unitEl=document.getElementById('pointUnit');
        if(nameEl)nameEl.textContent='Point';
        if(amountEl)amountEl.textContent=pts;
        if(unitEl)unitEl.textContent='PTS';
      }catch(e){
        console.error('Error fetching loyalty points:', e);
        const nameEl=document.getElementById('pointName');
        const amountEl=document.getElementById('pointAmount');
        const unitEl=document.getElementById('pointUnit');
        if(nameEl)nameEl.textContent='Point';
        if(amountEl)amountEl.textContent='0';
        if(unitEl)unitEl.textContent='PTS';
      }
    }
    function showHistoryScreen(){const accounts=JSON.parse(localStorage.getItem('mytelAccounts')||'[]');const msisdn=accounts[0]?.msisdn||'-';document.getElementById('historyMsisdn').textContent=msisdn;document.getElementById('dataScreen').style.display='none';document.getElementById('playScreen').style.display='none';document.getElementById('historyScreen').style.display='block';document.getElementById('btnEarn').classList.add('active');document.getElementById('btnBurn').classList.remove('active');fetchHistory('EARN')}
    function parseAndFormat(updateTime){const parts=updateTime.split(' ');if(parts.length<2)return updateTime;const hm=parts[0],dmy=parts[1];const HM=hm.split(':'),DMY=dmy.split('/');if(HM.length<2||DMY.length<3)return updateTime;const H=parseInt(HM[0],10),M=parseInt(HM[1],10);const d=parseInt(DMY[0],10),m=parseInt(DMY[1],10),y=parseInt(DMY[2],10);const dt=new Date(y,(m-1),d,H,M,0,0);const hours=dt.getHours()%12||12;const minutes=String(dt.getMinutes()).padStart(2,'0');return `${hours}:${minutes} ${d}/${String(m).padStart(2,'0')}/${y}`}
    async function fetchHistory(type){const list=document.getElementById('historyList');list.innerHTML='';const token=localStorage.getItem('mytelToken');const accounts=JSON.parse(localStorage.getItem('mytelAccounts')||'[]');const phone=accounts[0]?.msisdn||'';if(!token||!phone){list.innerHTML='<div class="history-card">No token or phone.</div>';return}const url=`https://apis.mytel.com.mm/loyalty/api/v3.1/history?phoneNo=${encodeURIComponent(phone)}&type=${type}&page=0&size=100`;try{const res=await fetch(url,{headers:{'Authorization':`Bearer ${token}`}});const data=await res.json();if(data&&data.errorCode==='00000'&&data.result&&Array.isArray(data.result.content)){data.result.content.forEach(item=>{const reason=item.reason;const amount=item.amount;const when=parseAndFormat(item.updateTime);const card=document.createElement('div');card.className='history-card';const row=document.createElement('div');row.className='history-row';const title=document.createElement('div');title.className='history-title';title.textContent=reason;const amt=document.createElement('div');amt.className='history-amount '+(type==='EARN'?'earn':'burn');amt.textContent=(type==='EARN'?'+':'-')+amount;row.appendChild(title);row.appendChild(amt);const date=document.createElement('div');date.className='history-date';date.textContent=when;card.appendChild(row);card.appendChild(date);list.appendChild(card)});if(data.result.content.length===0){list.innerHTML='<div class="history-card">No history.</div>'}}else{list.innerHTML='<div class="history-card">Unable to load history.</div>'}}catch(e){list.innerHTML='<div class="history-card">Error loading history.</div>'}}
    
    // Updated initializeSystem function
    function initializeSystem(){
        try{
            if(typeof getGameApis==='function'){
                window.apis=getGameApis();
                
                // Add any missing APIs
                addMissingApis();
                
                if(window.apis&&typeof window.apis==='object'){
                    document.getElementById('fetchTokenBtn').classList.remove('loading');
                    document.getElementById('fetchTokenBtn').disabled=false;
                    setTimeout(()=>{window.systemReady()},200);
                }else{
                    throw new Error('getGameApis returned invalid object: '+typeof window.apis);
                }
            }else{
                // If getGameApis is not available, create a mock apis object
                window.apis={};
                addMissingApis();
                
                document.getElementById('fetchTokenBtn').classList.remove('loading');
                document.getElementById('fetchTokenBtn').disabled=false;
                setTimeout(()=>{window.systemReady()},200);
            }
        }catch(e){
            document.getElementById('fetchTokenBtn').classList.remove('loading');
            document.getElementById('fetchTokenBtn').disabled=false;
            updateSystemStatus('System initialization failed','error');
            showPlayMessage('System Initialization Failed: '+e.message,'error');
        }
    }

    document.addEventListener('DOMContentLoaded',function(){
      if(tg){tg.expand();tg.enableClosingConfirmation()}
      showMainApp();
      document.getElementById('toggleVisibility').addEventListener('click',function(){const tokenInput=document.getElementById('token');const icon=this.querySelector('i');if(tokenInput.type==='password'){tokenInput.type='text';icon.classList.replace('fa-eye','fa-eye-slash')}else{tokenInput.type='password';icon.classList.replace('fa-eye-slash','fa-eye')}})
      document.querySelectorAll('.tab-btn').forEach(b=>{b.addEventListener('click',function(){document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));this.classList.add('active');document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));const tabId=this.getAttribute('data-tab');document.getElementById(tabId).classList.add('active')})})
      document.getElementById('startBtn').addEventListener('click',function(){const token=document.getElementById('token').value.trim();if(!token){showMessage('Please enter your token','error');return}this.classList.add('loading');this.disabled=true;fetchAccountData(token)})
      document.getElementById('sendOtpBtn').addEventListener('click',function(){const phone=document.getElementById('phoneNumberLogin').value.trim();if(!phone){showMessage('Please enter your phone number','error');return}if(!isValidMyanmarPhone(phone)){showMessage('Please enter a valid Myanmar phone number (09XXXXXXXX)','error');return}this.classList.add('loading');this.disabled=true;sendOtpRequest(phone)})
      document.getElementById('verifyOtpBtn').addEventListener('click',function(){const otp=document.getElementById('otpCode').value.trim();if(!otp||otp.length!==6){showMessage('Please enter a valid 6-digit OTP code','error');return}this.classList.add('loading');this.disabled=true;verifyOtpRequest(otp)})
      
      document.getElementById('playBtn').addEventListener('click',function(){document.getElementById('dataScreen').style.display='none';document.getElementById('playScreen').style.display='block';const accounts=JSON.parse(localStorage.getItem('mytelAccounts')||'[]');if(accounts.length>0){document.getElementById('phoneNumber').value=accounts[0].msisdn}updateSystemStatus('Not initialized','');document.getElementById('playerInfo').style.display='none';document.getElementById('gameLog').style.display='none';document.getElementById('statsDisplay').style.display='none';clearGameLog();document.getElementById('startAutoBtn').disabled=true;document.getElementById('diaToTurn').disabled=true;document.getElementById('heartToDia').disabled=true;document.getElementById('buy60HeartsBtn').disabled=true;updateAutoButtonState(false);autoInitOnPlay()})
      
      // Back to data button (on phone input)
      const backToDataBtn = document.getElementById('backToDataBtn');
      if (backToDataBtn) {
        backToDataBtn.addEventListener('click', function () {
          try { stopAutoGame(); } catch (_) {}
          document.getElementById('playScreen').style.display = 'none';
          document.getElementById('dataScreen').style.display = 'block';
        });
      }
      
      const backTop = document.getElementById('backToDataTop');
      if (backTop) {
        backTop.addEventListener('click', function () {
          try { stopAutoGame(); } catch (_) {}
          document.getElementById('playScreen').style.display = 'none';
          document.getElementById('dataScreen').style.display = 'block';
        });
      }
      document.getElementById('startAutoBtn').addEventListener('click',startAutoGame)
      document.getElementById('clearLog').addEventListener('click',clearGameLog)
      document.getElementById('fetchTokenBtn').addEventListener('click',function(){const token=localStorage.getItem('mytelToken');const phone=document.getElementById('phoneNumber').value.trim();if(!phone){showPlayMessage('Please Enter Phone Number','error');return}if(!token){showPlayMessage('No Authentication Token. Please login again.','error');return}this.classList.add('loading');this.disabled=true;updateSystemStatus('Initializing system...','loading');fetchMyIDToken(token,phone)})
      document.getElementById('token').addEventListener('input',function(){document.getElementById('startBtn').disabled=this.value.trim()===''})
      document.getElementById('phoneNumberLogin').addEventListener('input',function(){document.getElementById('sendOtpBtn').disabled=this.value.trim()===''})
      document.getElementById('otpCode').addEventListener('input',function(){document.getElementById('verifyOtpBtn').disabled=this.value.trim().length!==6})
      const historyBtn=document.querySelector('.history-btn');if(historyBtn){historyBtn.addEventListener('click',showHistoryScreen)}
      const btnEarn=document.getElementById('btnEarn');const btnBurn=document.getElementById('btnBurn');if(btnEarn){btnEarn.addEventListener('click',function(){this.classList.add('active');document.getElementById('btnBurn').classList.remove('active');fetchHistory('EARN')})}if(btnBurn){btnBurn.addEventListener('click',function(){this.classList.add('active');document.getElementById('btnEarn').classList.remove('active');fetchHistory('BURN')})}
      const backHome=document.getElementById('backToHome');if(backHome){backHome.addEventListener('click',function(){document.getElementById('historyScreen').style.display='none';document.getElementById('dataScreen').style.display='block'})}
      document.getElementById('startBtn').disabled=true;document.getElementById('sendOtpBtn').disabled=true;document.getElementById('verifyOtpBtn').disabled=true;
      const exBtn=document.querySelector('.exchange-btn');if(exBtn){exBtn.addEventListener('click',function(){document.getElementById('dataScreen').style.display='none';document.getElementById('playScreen').style.display='none';document.getElementById('historyScreen').style.display='none';document.getElementById('exchangeScreen').style.display='block';document.getElementById('exData').classList.add('active');document.getElementById('exVoice').classList.remove('active');document.getElementById('exSms').classList.remove('active');renderExchange('DATA')})}
      document.getElementById('exBack').addEventListener('click',function(){document.getElementById('exchangeScreen').style.display='none';document.getElementById('dataScreen').style.display='block'})
      document.getElementById('exData').addEventListener('click',function(){this.classList.add('active');document.getElementById('exVoice').classList.remove('active');document.getElementById('exSms').classList.remove('active');renderExchange('DATA')})
      document.getElementById('exVoice').addEventListener('click',function(){this.classList.add('active');document.getElementById('exData').classList.remove('active');document.getElementById('exSms').classList.remove('active');renderExchange('VOICE')})
      document.getElementById('exSms').addEventListener('click',function(){this.classList.add('active');document.getElementById('exData').classList.remove('active');document.getElementById('exVoice').classList.remove('active');renderExchange('SMS')})
      document.getElementById('confirmCancel').addEventListener('click',closeConfirm)
      document.getElementById('confirmOverlay').addEventListener('click',closeConfirm)
      document.getElementById('confirmOk').addEventListener('click',function(){if(pendingCode){_exchange(pendingCode)}closeConfirm()})
      document.getElementById('rOk').addEventListener('click',closeResult)
      document.getElementById('resultOverlay').addEventListener('click',closeResult)
      
      // Add event listener for buy button
      const b = document.getElementById('buy60HeartsBtn');
      if (b){ b.addEventListener('click', buyHeartPackage); }
      
      // Initialize button state
      updateAutoButtonState(false);
    });
    function showMessage(text,type){const el=document.getElementById('message');if(el){el.textContent=text;el.className='message '+type;el.style.display='block';if(type==='success')setTimeout(()=>{el.style.display='none'},5000)}}
    function isValidMyanmarPhone(p){return /^09[0-9]{7,9}$/.test(p)}
    async function sendOtpRequest(phone){const b=document.getElementById('sendOtpBtn');try{const r=await fetch('https://apis.mytel.com.mm/myid/authen/v1.0/login/method/otp/get-otp?phoneNumber='+phone);if(r.ok){otpRequestId=phone;startOtpTimer(60);document.getElementById('otpSection').style.display='block';document.getElementById('verifyOtpBtn').style.display='block';b.style.display='none';showMessage('OTP CODE SEND TO '+phone,'success')}else{throw new Error('Failed to send OTP')}}catch(e){showMessage('Failed to send OTP: '+e.message,'error')}finally{b.classList.remove('loading');b.disabled=false}}
    async function verifyOtpRequest(code){const b=document.getElementById('verifyOtpBtn');const phone=document.getElementById('phoneNumberLogin').value.trim();try{const r=await fetch('https://apis.mytel.com.mm/myid/authen/v1.0/login/method/otp/validate-otp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phoneNumber:phone,password:code,appVersion:'1.0.93',buildVersionApp:'217',deviceId:'0',imei:'0',os:'MINI MYID PLUS (ALPHA) PRO+',Android:'IOS',version:''})});const d=await r.json();if(d.errorCode===200&&d.result&&d.result.access_token){const token=d.result.access_token;localStorage.setItem('mytelToken',token);showMessage('LOGIN SUCCESSFUL','success');setTimeout(()=>{document.getElementById('tokenScreen').style.display='none';document.getElementById('dataScreen').style.display='block';fetchAccountData(token)},1000)}else{throw new Error(d.message||'Invalid OTP or token not received')}}catch(e){showMessage('OTP Verification Failed: '+e.message,'error')}finally{b.classList.remove('loading');b.disabled=false}}
    function startOtpTimer(seconds){const el=document.createElement('div');el.className='otp-timer';el.id='otpTimer';const sec=document.getElementById('otpSection');const exist=document.getElementById('otpTimer');if(exist)exist.remove();sec.appendChild(el);otpExpiryTime=Date.now()+seconds*1000;otpTimer=setInterval(()=>{const now=Date.now();const remain=Math.max(0,Math.floor((otpExpiryTime-now)/1000));if(remain<=0){clearInterval(otpTimer);el.innerHTML='OTP Expired. <button class="resend-otp" id="resendOtp">Resend OTP</button>';document.getElementById('resendOtp').addEventListener('click',resendOtp)}else{const m=Math.floor(remain/60);const s=remain%60;el.textContent=`OTP Expires in: ${m}:${s.toString().padStart(2,'0')}`;if(remain<=30)el.classList.add('expiring')}},1000)}
    function resendOtp(){const phone=document.getElementById('phoneNumberLogin').value.trim();if(phone)sendOtpRequest(phone)}
    function resetOtpLogin(){if(otpTimer)clearInterval(otpTimer);document.getElementById('otpSection').style.display='none';document.getElementById('verifyOtpBtn').style.display='none';document.getElementById('sendOtpBtn').style.display='flex';document.getElementById('otpBtnText').textContent='SEND OTP';const t=document.getElementById('otpTimer');if(t)t.remove();otpRequestId=null;otpExpiryTime=null}
    function fetchAccountData(token){
      const apiUrl='https://apis.mytel.com.mm/account-detail/api/v1.2/individual/account-main?isdn=09666666666&language=en';
      fetch(apiUrl,{method:'GET',headers:{'Authorization':`Bearer ${token}`}})
      .then(r=>{if(!r.ok)throw new Error('Network response was not ok');return r.json()})
      .then(data=>{
        document.getElementById('startBtn').classList.remove('loading');
        document.getElementById('startBtn').disabled=false;
        if(data.errorCode===0){
          const all=Array.isArray(data.result)?data.result:(data.result?[data.result]:[]);
          const mytelOnly=all.find(a=>a&&a.mytel===true)||all[0];
          if(!mytelOnly){showMessage('No Mytel account found on this login.','error');return}
          localStorage.setItem('mytelToken',token);
          localStorage.setItem('mytelAccounts',JSON.stringify([mytelOnly]));
          
          // Auto-save account after successful login
          setTimeout(() => {
            if (typeof window.autoSaveAccount === 'function') {
              window.autoSaveAccount();
            }
          }, 500);
          
          document.getElementById('tokenScreen').style.display='none';
          document.getElementById('dataScreen').style.display='block';
          displayAccountData([mytelOnly]);
          fetchLoyaltyPoints(token);
          const phone=mytelOnly.msisdn||'';
          if(phone){fetchMemberSummary(token,phone)}
        }else{
          showMessage(`API Error[1820]: ${data.message||'Unknown error'}`,'error')
        }
      })
      .catch(_=>{
        document.getElementById('startBtn').classList.remove('loading');
        document.getElementById('startBtn').disabled=false;
        showMessage('Failed to fetch account data. Please check your token and try again.','error')
      });
    }
    function displayAccountData(accounts){
      const cont=document.getElementById('accountsContainer');
      cont.innerHTML='';
      const my=Array.isArray(accounts)?accounts.filter(acc=>acc&&acc.mytel===true):[];
      const list=my.length>0?[my[0]]:(Array.isArray(accounts)&&accounts.length?[accounts[0]]:[]);
      if(list.length===0){showMessage('No account to display','error');return}
      list.forEach(account=>{
        const card=document.createElement('div');
        card.className='account-card';
        card.innerHTML=`
          <div class="account-header">
            <div class="header-left">
              <div class="msisdn">${account.msisdn}</div>
              <button class="mytel-badge mini-refresh" title="Refresh"><i class="fas fa-sync-alt"></i></button>
            </div>
            <button class="claim-btn">
              <i class="fa-solid fa-trophy"></i>
              <span>Claim Point</span>
              <span class="spinner-mini"></span>
            </button>
          </div>
          <div class="balance-grid">
            <div class="balance-item"><div class="balance-name">${account.mainBalance.main.name}</div><div class="balance-amount">${account.mainBalance.main.amount}</div><div class="balance-unit">${account.mainBalance.main.unit}</div></div>
            <div class="balance-item"><div class="balance-name" id="pointName"></div><div class="balance-amount" id="pointAmount"><i class="fas fa-spinner fa-spin"></i></div><div class="balance-unit" id="pointUnit">PTS</div></div>
            <div class="balance-item"><div class="balance-name">${account.mainBalance.voice.name}</div><div class="balance-amount">${account.mainBalance.voice.amount}</div><div class="balance-unit">${account.mainBalance.voice.unit}</div></div>
            <div class="balance-item"><div class="balance-name">${account.mainBalance.data.name}</div><div class="balance-amount">${account.mainBalance.data.amount}</div><div class="balance-unit">${account.mainBalance.data.unit}</div></div>
          </div>
        `;
        cont.appendChild(card);
        const badge=card.querySelector('.mini-refresh');
        if(badge){badge.addEventListener('click',function(){const token=localStorage.getItem('mytelToken');if(token){fetchAccountData(token)}})}
        const claimBtn = card.querySelector('.claim-btn');
        if (claimBtn) {
          claimBtn.addEventListener('click', async function(){
            const token = localStorage.getItem('mytelToken');
            const msisdn = formatMsisdn(account.msisdn || '');
            if (!token || !msisdn) { openResult(false,'Token သို့မဟုတ် ဖုန်းနံပါတ် မရှိပါ'); return; }
            this.classList.add('loading');
            try{
              const res = await fetch('claim_point.php',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ token, msisdn })});
              const d = await res.json().catch(()=>({}));
              const ok = isApiSuccess(d, res);
              openResult(ok, d.message || (ok ? 'Claim success' : 'Claim failed'));
              if(ok){
                const t = localStorage.getItem('mytelToken'); if (t) fetchLoyaltyPoints(t);
              }
            }catch(e){openResult(false,'Network error')}finally{this.classList.remove('loading')}
          });
        }
      });
    }
    // Auto retry mechanism for failed token
    let tokenRetryCount = 0;
    const MAX_TOKEN_RETRIES = 3;
    let retryTimeoutId = null;
    
    function fetchMyIDToken(token, phone, isAutoRetry = false) {
        const php = 'fetch_token.php';
        
        // Clear any existing retry timeout
        if (retryTimeoutId) {
            clearTimeout(retryTimeoutId);
            retryTimeoutId = null;
        }
        
        fetch(php, {
            method: 'GET',
            headers: {
                'access-token': token,
                'phone-number': phone
            }
        })
        .then(r => {
            if (!r.ok) throw new Error('Network response was not ok');
            return r.json();
        })
        .then(d => {
            if (d.success && d.token) {
                // Success - reset retry count
                tokenRetryCount = 0;
                window.token = d.token;
                loadGatewayJS();
            } else {
                document.getElementById('fetchTokenBtn').classList.remove('loading');
                document.getElementById('fetchTokenBtn').disabled = false;
                updateSystemStatus(d.message || 'No token found in response', 'error');
                showPlayMessage(d.message || 'Token Not Found Response', 'error');
                
                // Auto retry if under max retries
                if (tokenRetryCount < MAX_TOKEN_RETRIES) {
                    scheduleTokenRetry(token, phone);
                }
            }
        })
        .catch(_ => {
            document.getElementById('fetchTokenBtn').classList.remove('loading');
            document.getElementById('fetchTokenBtn').disabled = false;
            updateSystemStatus('Failed to fetch token', 'error');
            showPlayMessage('Failed Token Please Try Again.', 'error');
            
            // Auto retry if under max retries
            if (tokenRetryCount < MAX_TOKEN_RETRIES) {
                scheduleTokenRetry(token, phone);
            } else {
                // Max retries reached
                tokenRetryCount = 0;
                showPlayMessage('Max retries reached. Please try again manually.', 'error');
            }
        });
    }
    
    function scheduleTokenRetry(token, phone) {
        tokenRetryCount++;
        const retryDelay = 2000; // 2 seconds fast retry
        let countdown = Math.ceil(retryDelay / 1000);
        
        updateSystemStatus(`Retrying in ${countdown}s... (Attempt ${tokenRetryCount}/${MAX_TOKEN_RETRIES})`, 'loading');
        showPlayMessage(`Auto retry in ${countdown} seconds... (${tokenRetryCount}/${MAX_TOKEN_RETRIES})`, 'info');
        
        // Update countdown every second
        const countdownInterval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                updateSystemStatus(`Retrying in ${countdown}s... (Attempt ${tokenRetryCount}/${MAX_TOKEN_RETRIES})`, 'loading');
                showPlayMessage(`Auto retry in ${countdown} seconds... (${tokenRetryCount}/${MAX_TOKEN_RETRIES})`, 'info');
            } else {
                clearInterval(countdownInterval);
            }
        }, 1000);
        
        // Schedule the retry
        retryTimeoutId = setTimeout(() => {
            clearInterval(countdownInterval);
            updateSystemStatus('Retrying token fetch...', 'loading');
            showPlayMessage('Retrying...', 'info');
            document.getElementById('fetchTokenBtn').classList.add('loading');
            document.getElementById('fetchTokenBtn').disabled = true;
            fetchMyIDToken(token, phone, true);
        }, retryDelay);
    }
    function loadGatewayJS(){const s=document.createElement('script');s.src='main/gateway.js';s.onload=function(){initializeSystem()};s.onerror=function(){document.getElementById('fetchTokenBtn').classList.remove('loading');document.getElementById('fetchTokenBtn').disabled=false;updateSystemStatus('Failed to load gateway.js','error');showPlayMessage('Failed To Load Gateway.js Please Try Again.','error')};document.getElementById('gatewayScriptContainer').innerHTML='';document.getElementById('gatewayScriptContainer').appendChild(s)}
    
    async function fetchMemberSummary(token, phone){
      const url=`https://apis.mytel.com.mm/loyalty/api/v3.1/customer/inquiry?phoneNo=${encodeURIComponent(phone)}`;
      try{
        const res=await fetch(url,{headers:{'Authorization':`Bearer ${token}`,'Accept-Language':'EN','Accept-Encoding':'gzip'}});
        const d=await res.json();
        const card=document.getElementById('memberCard');
        if(d && d.errorCode==='00000' && d.result){
          const r=d.result, ext=r.extendInfo||{};
          const exchanged=Number(ext.exchanged||0);
          const monthlyLimit=Number(ext.monthlyLimit||0);
          const extended=Number(ext.extended||0);
          const max=monthlyLimit+extended;
          document.getElementById('memberTitle').textContent=(r.rankName||'')+' Member';
          document.getElementById('memberPoint').textContent=r.exchangePoints||'0';
          document.getElementById('memberExchangeText').innerHTML=`<span class="exchanged">${exchanged}</span>/<span class="limit">${monthlyLimit}</span>(<span class="extended">+${extended}</span>)`;
          const pct=max>0 ? (Math.min(exchanged,max)/max)*100 : 0;
          document.getElementById('memberProgress').style.width=pct+'%';
          card.style.display='block';
        }else{
          document.getElementById('memberCard').style.display='none';
        }
      }catch(e){
        document.getElementById('memberCard').style.display='none';
      }
    }

    // Custom Background and Sound Functionality
    let customAudio = null;
    
    document.getElementById('bgInput').addEventListener('change', function () {
      const file = this.files && this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (ev) {
        const dataUrl = ev.target.result;
        const container = document.querySelector('.container');
        if (container) {
          container.style.setProperty(
            'background',
            'url(' + dataUrl + ') center / cover no-repeat',
            'important'
          );
        }
        try {
          localStorage.setItem('customBackground', dataUrl);
        } catch (err) {
          console.error('Failed to save custom background:', err);
        }
      };
      reader.readAsDataURL(file);
    });

    function loadCustomSound() {
      const savedSound = localStorage.getItem('customSound');
      if (savedSound) {
        try {
          customAudio = new Audio(savedSound);
          customAudio.loop = true;
        } catch (err) {
          console.error('Failed to load custom sound:', err);
        }
      }
    }

    document.getElementById('soundInput').addEventListener('change', function () {
      const file = this.files && this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        const dataUrl = ev.target.result;
        try {
          localStorage.setItem('customSound', dataUrl);
        } catch (err) {
          console.error('Failed to save custom sound:', err);
        }
        try {
          customAudio = new Audio(dataUrl);
          customAudio.loop = true;
          customAudio.currentTime = 0;
          customAudio.play().catch(() => {});
        } catch(e) {
          console.error('Failed to set custom sound:', e);
        }
      };
      reader.readAsDataURL(file);
    });

    function playSound() {
      try {
        if (customAudio) {
          // Don't restart background music, just keep it playing
          // customAudio.currentTime = 0;  // Removed: prevents restart
          // customAudio.play().catch(() => {});  // Removed: already playing
        }
      } catch(e) {
        console.error('Failed to play sound:', e);
      }
    }

    window.addEventListener('DOMContentLoaded', function () {
      const savedBg = localStorage.getItem('customBackground');
      if (savedBg) {
        const container = document.querySelector('.container');
        if (container) {
          container.style.setProperty(
            'background',
            'url(' + savedBg + ') center / cover no-repeat',
            'important'
          );
        }
      }
      loadCustomSound();
    });

    // FAB functionality
    (function() {
      const mainFab = document.getElementById('mainFab');
      const options = document.getElementById('fabOptions');
      const imageOpt = document.getElementById('imageOption');
      const soundOpt = document.getElementById('soundOption');
      const timerOpt = document.getElementById('timerOption');
      const clearOpt = document.getElementById('clearOption');
      const refreshOpt = document.getElementById('refreshOption');
      const switchOpt = document.getElementById('switchOption');
      const logoutOpt = document.getElementById('logoutOption');
      
      if (mainFab && options && imageOpt && soundOpt) {
        function closeFab() {
          options.style.display = 'none';
          mainFab.classList.remove('open');
        }
        
        mainFab.addEventListener('click', function (ev) {
          ev.stopPropagation();
          const isOpen = options.style.display === 'flex';
          options.style.display = isOpen ? 'none' : 'flex';
          if (isOpen) {
            mainFab.classList.remove('open');
          } else {
            mainFab.classList.add('open');
          }
        });
        
        document.addEventListener('click', function (ev) {
          if (!options.contains(ev.target) && ev.target !== mainFab && !mainFab.contains(ev.target)) {
            closeFab();
          }
        });
        
        document.addEventListener('keydown', function (ev) {
          if (ev.key === 'Escape') closeFab();
        });
        
        imageOpt.addEventListener('click', function () {
          closeFab();
          const input = document.getElementById('bgInput');
          if (input) input.click();
        });
        
        soundOpt.addEventListener('click', function () {
          closeFab();
          const input = document.getElementById('soundInput');
          if (input) input.click();
        });
        
        timerOpt.addEventListener('click', function () {
          closeFab();
          if (typeof openTimerDialogMulti === 'function') {
            openTimerDialogMulti();
          }
        });
        
        // Silent Game Token Refresh Function
        async function refreshGameTokenSilently() {
          const authToken = localStorage.getItem('mytelToken');
          const accounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
          const phone = accounts[0]?.msisdn || '';
          
          if (!authToken) {
            showMessage('No auth token found. Please login first.', 'error');
            return;
          }
          
          if (!phone) {
            showMessage('No phone number found. Please login first.', 'error');
            return;
          }
          
          // Backup old game token
          const oldGameToken = window.token || null;
          console.log('🔄 Backing up old game token:', oldGameToken ? 'exists' : 'none');
          
          const php = 'fetch_token.php';
          
          try {
            const response = await fetch(php, {
              method: 'GET',
              headers: {
                'access-token': authToken,
                'phone-number': phone
              }
            });
            
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            
            const data = await response.json();
            
            if (data.success && data.token) {
              // Success - update with new token
              window.token = data.token;
              console.log('✅ Game token refreshed successfully');
              showMessage('Game token refreshed successfully', 'success');
            } else {
              // Failed to get new token - restore old token
              if (oldGameToken) {
                window.token = oldGameToken;
                console.log('⚠️ Failed to get new token. Restored old token.');
                showMessage('Failed to refresh token. Using old token.', 'error');
              } else {
                console.log('❌ No new token and no old token to restore.');
                showMessage('Failed to get game token: ' + (data.message || 'Unknown error'), 'error');
              }
            }
          } catch (error) {
            // Network error - restore old token
            if (oldGameToken) {
              window.token = oldGameToken;
              console.log('⚠️ Network error. Restored old token.');
              showMessage('Network error. Using old token.', 'error');
            } else {
              console.log('❌ Network error and no old token to restore.');
              showMessage('Network error. No token available.', 'error');
            }
          }
        }
        
        // Refresh Token option
        if (refreshOpt) {
          refreshOpt.addEventListener('click', function() {
            closeFab();
            refreshGameTokenSilently();
          });
        }
        
        // Switch Account option
        if (switchOpt) {
          switchOpt.addEventListener('click', function() {
            closeFab();
            if (typeof openSwitchAccountModal === 'function') {
              openSwitchAccountModal();
            }
          });
        }
        
        // Logout option
        if (logoutOpt) {
          logoutOpt.addEventListener('click', function() {
            closeFab();
            localStorage.removeItem('mytelToken');
            localStorage.removeItem('mytelAccounts');
            document.getElementById('tokenScreen').style.display='block';
            document.getElementById('dataScreen').style.display='none';
            document.getElementById('token').value='';
            document.getElementById('startBtn').disabled=true;
            showMessage('Logout Successful','success');
          });
        }
        
        if (clearOpt) {
          clearOpt.addEventListener('click', function() {
            closeFab();
            try {
              localStorage.removeItem('customBackground');
            } catch (err) {}
            const containerEl = document.querySelector('.container');
            if (containerEl) {
              containerEl.style.removeProperty('background');
            }
            try {
              localStorage.removeItem('customSound');
            } catch (err) {}
            if (customAudio) {
              try { customAudio.pause(); } catch(e) {}
            }
            customAudio = null;
          });
        }
      }
    })();

    // Auto Play Custom Timer - Multi Windows
    (function(){
      function _mins(hhmm){
        var t = (hhmm||'').split(':');
        return (parseInt(t[0]||'0',10)*60) + (parseInt(t[1]||'0',10));
      }
      function _inWindow(nM, sM, eM){
        return (sM < eM) ? (nM >= sM && nM < eM) : (nM >= sM || nM < eM);
      }
      function _loadWindows(){
        try {
          var raw = localStorage.getItem('autoTimeWindows');
          var arr = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(arr)) return [];
          return arr.filter(function(w){ return w && w.start && w.stop; });
        } catch(e){ return []; }
      }
      function _saveWindows(arr){
        localStorage.setItem('autoTimeWindows', JSON.stringify(arr||[]));
      }
      function _enabled(){ 
        var v = localStorage.getItem('autoSchedulerEnabled'); 
        return (v === null || v === '1'); 
      }
      function _setEnabled(v){
        localStorage.setItem('autoSchedulerEnabled', v ? '1' : '0');
      }

      function updateAutoButtonState(isRunning) {
        const btn = document.getElementById('startAutoBtn');
        if (!btn) return;
        
        if (isRunning) {
            btn.innerHTML = '<i class="fas fa-stop"></i> ရပ်မယ်';
            btn.classList.add('auto-btn-stop');
        } else {
            btn.innerHTML = '<i class="fas fa-play"></i> ကစားမယ်';
            btn.classList.remove('auto-btn-stop');
        }
      }

      function openTimerDialogMulti(){
        var arr = _loadWindows();
        if (arr.length === 0) arr = [{start:'08:00', stop:'23:00'}];
        var enabled = _enabled();

        var rows = arr.map(function(w, idx){
          return (
            '<div class="tw-row" data-idx="'+idx+'" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">'
            + '<input class="tw-start" type="time" value="'+w.start+'" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px;">'
            + '<span style="width:20px;text-align:center;">–</span>'
            + '<input class="tw-stop" type="time" value="'+w.stop+'" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px;">'
            + '<button class="tw-del" style="background:#F44336;color:#fff;border:none;border-radius:8px;padding:8px 10px;font-weight:700;">Del</button>'
            + '</div>'
          );
        }).join('');

        var html = ''
          + '<div id="timerDialog" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:2000;display:flex;align-items:center;justify-content:center;">'
          + '  <div style="background:#fff;border-radius:16px;padding:20px;width:92%;max-width:420px;">'
          + '    <h3 style="margin:0 0 8px;color:#333;text-align:center;">Auto Play Scheduler</h3>'
          + '    <label style="display:flex;align-items:center;gap:8px;margin:8px 0 14px;cursor:pointer;">'
          + '      <input id="twEnabled" type="checkbox" '+(enabled?'checked':'')+' /> Enable Scheduler'
          + '    </label>'
          + '    <div id="twList">'+ rows +'</div>'
          + '    <button id="twAdd" style="width:100%;background:#4CAF50;color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:800;margin:6px 0 14px;">+ Add Time Range</button>'
          + '    <div style="display:flex;gap:10px;justify-content:center;">'
          + '      <button id="twSave" style="flex:1;background:#4CAF50;color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:800;">Save</button>'
          + '      <button id="twCancel" style="flex:1;background:#9e9e9e;color:#fff;border:none;border-radius:10px;padding:10px 12px;font-weight:800;">Cancel</button>'
          + '    </div>'
          + '  </div>'
          + '</div>';

        document.body.insertAdjacentHTML('beforeend', html);

        var root = document.getElementById('timerDialog');
        var list = document.getElementById('twList');
        document.getElementById('twCancel').onclick = function(){ root.remove(); };
        document.getElementById('twAdd').onclick = function(){
          var el = document.createElement('div');
          el.className = 'tw-row';
          el.style = 'display:flex;gap:8px;align-items:center;margin-bottom:8px;';
          el.innerHTML = ''
            + '<input class="tw-start" type="time" value="08:00" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px;">'
            + '<span style="width:20px;text-align:center;">–</span>'
            + '<input class="tw-stop" type="time" value="23:00" style="flex:1;padding:10px;border:1px solid #ccc;border-radius:8px;">'
            + '<button class="tw-del" style="background:#F44336;color:#fff;border:none;border-radius:8px;padding:8px 10px;font-weight:700;">Del</button>';
          list.appendChild(el);
          el.querySelector('.tw-del').onclick = function(){ el.remove(); };
        };
        Array.prototype.forEach.call(list.querySelectorAll('.tw-del'), function(btn){
          btn.onclick = function(){ btn.parentElement.remove(); };
        });
        document.getElementById('twSave').onclick = function(){
          var rows = list.querySelectorAll('.tw-row');
          var out = [];
          rows.forEach(function(r){
            var s = (r.querySelector('.tw-start').value || '08:00').slice(0,5);
            var e = (r.querySelector('.tw-stop').value  || '23:00').slice(0,5);
            out.push({start:s, stop:e});
          });
          _saveWindows(out);
          _setEnabled(document.getElementById('twEnabled').checked);
          try { 
            if (window.addGameLog) addGameLog('Scheduler saved: '+JSON.stringify(out), 'info'); 
          } catch(e){}
          
          setTimeout(function() {
            checkAutoTimerMulti(true);
          }, 1000);
          
          root.remove();
        };
      }

      function _legacyInWindow(nM){
        var st = localStorage.getItem('autoStartTime');
        var et = localStorage.getItem('autoStopTime');
        if (!st || !et) return false;
        var sM = _mins(st), eM = _mins(et);
        return _inWindow(nM, sM, eM);
      }

      function checkAutoTimerMulti(force){
        if (!_enabled() && !force) return;

        var now = new Date();
        var nM  = now.getHours()*60 + now.getMinutes();
        var windows = _loadWindows();
        var inAny = false;

        if (windows.length > 0){
          for (var i=0;i<windows.length;i++){
            var w = windows[i];
            if (!w || !w.start || !w.stop) continue;
            if (_inWindow(nM, _mins(w.start), _mins(w.stop))){
              inAny = true; break;
            }
          }
        } else {
          inAny = _legacyInWindow(nM);
        }

        console.log('🕒 Schedule Check:', { 
          currentTime: now.toLocaleTimeString(), 
          inSchedule: inAny, 
          windows: windows,
          gameRunning: window.gameState?.isAutoRunning 
        });

        if (inAny) {
          if (window.gameState && !window.gameState.isAutoRunning && typeof window.startAutoGame === 'function') {
            console.log('🟢 Auto STARTING - Within schedule');
            window.startAutoGame();
            updateAutoButtonState(true);
          }
        } else {
          if (window.gameState && window.gameState.isAutoRunning && typeof window.stopAutoGame === 'function') {
            console.log('🔴 Auto STOPPING - Outside schedule');
            window.stopAutoGame();
            updateAutoButtonState(false);
          }
        }
      }

      document.addEventListener('DOMContentLoaded', function(){
        var topt = document.getElementById('timerOption');
        if (topt) topt.addEventListener('click', openTimerDialogMulti);
        
        setTimeout(function(){ 
          checkAutoTimerMulti(true); 
        }, 3000);
        setInterval(checkAutoTimerMulti, 60000);
      });
    })();

    // Auto Start On Load If Scheduled
    (function(){
      document.addEventListener('DOMContentLoaded', function(){
        setTimeout(function() {
          try {
            if (typeof checkAutoTimerMulti === 'function') {
              console.log('🚀 Initial auto schedule check...');
              checkAutoTimerMulti(true);
            }
          } catch(e) {
            console.error('Initial schedule check error:', e);
          }
        }, 5000);

        var attempts = 0;
        var maxAttempts = 30;
        var iv = setInterval(function(){
          attempts++;
          try {
            if (typeof checkAutoTimerMulti === 'function') {
              checkAutoTimerMulti(true);
            }
            if ((window.gameState && window.gameState.isAutoRunning) || attempts >= maxAttempts) {
              clearInterval(iv);
            }
          } catch(e){
            if (attempts >= maxAttempts) clearInterval(iv);
          }
        }, 2000);
      });
    })();

    // Diagnostic function
    window.checkSchedulerStatus = function() {
        const now = new Date();
        const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
        
        return {
            currentTime: currentTime,
            schedulerEnabled: localStorage.getItem('autoSchedulerEnabled'),
            timeWindows: JSON.parse(localStorage.getItem('autoTimeWindows') || '[]'),
            gameRunning: window.gameState?.isAutoRunning,
            buttonText: document.getElementById('startAutoBtn')?.innerText
        };
    };

    console.log('🔧 Scheduler Status:', window.checkSchedulerStatus());
</script>

<script>
/* === Auto Play Orchestrator (v3) — start only after play init ===
   Rules:
   - DO NOT auto-navigate to Play screen.
   - Wait until user has manually entered Play screen and systemReady.
   - Then check schedule and start/stop accordingly.
*/
(function(){
  var orchestrator = {
    init: function(){
      console.log('🕹️ Orchestrator init');
      orchestrator.iv = setInterval(function(){
        if (orchestrator.isPlayScreenActive() && orchestrator.isSystemReady()) {
          console.log('🎮 Play screen active & system ready, checking schedule...');
          orchestrator.check();
        }
      }, 10000); // check every 10 seconds
    },
    isPlayScreenActive: function(){
      var ps = document.getElementById('playScreen');
      return ps && window.getComputedStyle(ps).display !== 'none';
    },
    isSystemReady: function(){
      return window.gameState && window.apis && typeof window.startAutoGame === 'function';
    },
    check: function(){
      if (typeof checkAutoTimerMulti === 'function') {
        checkAutoTimerMulti();
      }
    }
  };
  document.addEventListener('DOMContentLoaded', function(){
    setTimeout(orchestrator.init, 5000);
  });
})();
</script>

<script>
/* === Game Mode Switcher === */
(function() {
    document.addEventListener('DOMContentLoaded', function() {
        const gameModeSelector = document.getElementById('gameMode');
        
        if (gameModeSelector) {
            gameModeSelector.addEventListener('change', function() {
                // Just update button text to show selected mode
                // Don't stop game or add logs - let user click button to start
                updateAutoButtonState(false);
            });
            
            console.log('✅ Game Mode switcher initialized');
        }
    });
})();
</script>

<script>
/* === Switch Account Functionality === */
(function() {
    const STORAGE_KEY = 'savedAccounts';
    
    // Initialize saved accounts from localStorage
    function getSavedAccounts() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : [];
        } catch (e) {
            console.error('Error loading saved accounts:', e);
            return [];
        }
    }
    
    // Save accounts to localStorage
    function saveSavedAccounts(accounts) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
            return true;
        } catch (e) {
            console.error('Error saving accounts:', e);
            return false;
        }
    }
    
    // Get current account info
    function getCurrentAccountInfo() {
        const token = localStorage.getItem('authToken');
        const msisdn = localStorage.getItem('msisdn');
        
        if (!token || !msisdn) {
            return null;
        }
        
        return {
            msisdn: msisdn,
            token: token,
            savedAt: new Date().toISOString()
        };
    }
    
    // Auto-save account after successful login
    window.autoSaveAccount = function() {
        try {
            // Get account info from mytelAccounts
            const mytelAccounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
            const token = localStorage.getItem('mytelToken');
            
            if (!token || mytelAccounts.length === 0) {
                console.log('No account data to save');
                return;
            }
            
            const msisdn = mytelAccounts[0].msisdn;
            if (!msisdn) {
                console.log('No msisdn found');
                return;
            }
            
            const accountInfo = {
                msisdn: msisdn,
                token: token,
                savedAt: new Date().toISOString()
            };
            
            const accounts = getSavedAccounts();
            
            // Check if account already exists
            const existingIndex = accounts.findIndex(acc => acc.msisdn === accountInfo.msisdn);
            
            if (existingIndex !== -1) {
                // Update existing account
                accounts[existingIndex] = accountInfo;
                console.log('✅ Account updated:', accountInfo.msisdn);
            } else {
                // Add new account
                accounts.push(accountInfo);
                console.log('✅ Account saved:', accountInfo.msisdn);
            }
            
            saveSavedAccounts(accounts);
        } catch (e) {
            console.error('Error auto-saving account:', e);
        }
    };
    
    // Open switch account modal
    window.openSwitchAccountModal = function() {
        const modal = document.getElementById('switchAccountModal');
        if (modal) {
            modal.classList.add('active');
            renderSavedAccounts();
        }
    };
    
    // Close switch account modal
    window.closeSwitchAccountModal = function() {
        const modal = document.getElementById('switchAccountModal');
        if (modal) {
            modal.classList.remove('active');
        }
    };
    
    // Render saved accounts list
    function renderSavedAccounts() {
        const container = document.getElementById('savedAccountsList');
        if (!container) return;
        
        const accounts = getSavedAccounts();
        const mytelAccounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
        const currentMsisdn = mytelAccounts.length > 0 ? mytelAccounts[0].msisdn : null;
        
        if (accounts.length === 0) {
            container.innerHTML = `
                <div class="no-accounts-msg">
                    <i class="fas fa-users" style="font-size:48px;margin-bottom:15px;color:#ddd;"></i>
                    <p>No saved accounts yet.<br>Accounts are automatically saved when you login successfully.</p>
                </div>
            `;
            return;
        }
        
        let html = '';
        accounts.forEach((account, index) => {
            const isCurrent = account.msisdn === currentMsisdn;
            const date = new Date(account.savedAt);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            
            html += `
                <div class="saved-account-item ${isCurrent ? 'current-account' : ''}">
                    <div class="saved-account-info">
                        <div class="saved-account-phone">
                            ${account.msisdn}
                            ${isCurrent ? '<span class="current-badge">CURRENT</span>' : ''}
                        </div>
                        <div class="saved-account-date">Saved: ${formattedDate}</div>
                    </div>
                    <div class="saved-account-actions">
                        ${!isCurrent ? `<button class="account-action-btn switch-account-btn" onclick="switchToAccount(${index})">
                            <i class="fas fa-arrow-right"></i> Switch
                        </button>` : ''}
                        <button class="account-action-btn delete-account-btn" onclick="deleteAccount(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    // Save current account
    // Switch to a saved account
    window.switchToAccount = function(index) {
        const accounts = getSavedAccounts();
        
        if (index < 0 || index >= accounts.length) {
            showMessage('Invalid account selection!', 'error');
            return;
        }
        
        const account = accounts[index];
        const mytelAccounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
        const currentMsisdn = mytelAccounts.length > 0 ? mytelAccounts[0].msisdn : null;
        
        // Check if trying to switch to current account
        if (account.msisdn === currentMsisdn) {
            showMessage('This is already your current account!', 'info');
            return;
        }
        
        // Confirm switch
        if (!confirm(`Switch to account ${account.msisdn}?\n\nThis will reload the page.`)) {
            return;
        }
        
        // Clear any cached game data
        try {
            const keysToKeep = ['savedAccounts', 'bgImageUrl', 'bgType', 'customBgColor', 
                               'gameSound', 'autoSchedulerEnabled', 'autoTimeWindows',
                               'autoStartTime', 'autoStopTime', 'deviceId'];
            const allKeys = Object.keys(localStorage);
            allKeys.forEach(key => {
                if (!keysToKeep.includes(key)) {
                    localStorage.removeItem(key);
                }
            });
        } catch (e) {
            console.error('Error clearing cache:', e);
        }
        
        // Switch account - set the token and create account structure
        localStorage.setItem('mytelToken', account.token);
        localStorage.setItem('mytelAccounts', JSON.stringify([{
            msisdn: account.msisdn,
            mytel: true
        }]));
        
        console.log('✅ Switched to account:', account.msisdn);
        
        showMessage('Switching to ' + account.msisdn + '...', 'success');
        closeSwitchAccountModal();
        
        // Reload the page to refresh with new account
        setTimeout(() => {
            window.location.reload(true); // Force reload from server
        }, 800);
    };
    
    // Delete a saved account
    window.deleteAccount = function(index) {
        const accounts = getSavedAccounts();
        
        if (index < 0 || index >= accounts.length) {
            showMessage('Invalid account selection!', 'error');
            return;
        }
        
        const account = accounts[index];
        const mytelAccounts = JSON.parse(localStorage.getItem('mytelAccounts') || '[]');
        const currentMsisdn = mytelAccounts.length > 0 ? mytelAccounts[0].msisdn : null;
        
        // Confirm deletion
        if (!confirm(`Delete account ${account.msisdn}?`)) {
            return;
        }
        
        // Remove account
        accounts.splice(index, 1);
        
        if (saveSavedAccounts(accounts)) {
            showMessage('Account deleted successfully!', 'success');
            renderSavedAccounts();
            
            // If deleted current account, logout
            if (account.msisdn === currentMsisdn) {
                setTimeout(() => {
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.click();
                    }
                }, 1500);
            }
        }
    };
    
    // Show message helper
    function showMessage(text, type) {
        const existingMsg = document.querySelector('.message');
        if (existingMsg) {
            existingMsg.remove();
        }
        
        const msg = document.createElement('div');
        msg.className = `message ${type}`;
        msg.textContent = text;
        msg.style.display = 'block';
        
        const modal = document.querySelector('.modal-content');
        if (modal) {
            modal.insertBefore(msg, modal.firstChild);
            
            setTimeout(() => {
                msg.remove();
            }, 3000);
        }
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('switchAccountModal');
        if (modal && e.target === modal) {
            closeSwitchAccountModal();
        }
    });
    
    console.log('✅ Switch Account functionality initialized');
})();

// Prize Dialog Functions
function showPrizeDialog(type, amount, gameMode) {
    const dialog = document.getElementById('prizeDialog');
    const image = document.getElementById('prizeImage');
    const name = document.getElementById('prizeName');
    const description = document.getElementById('prizeDescription');
    
    if (!dialog || !image || !name || !description) {
        console.error('❌ Prize dialog elements not found');
        return;
    }
    
    // Get game mode display name
    const gameModeText = gameMode || 'Unknown Game';
    
    // Set prize details based on type
    let prizeData = {};
    switch(type) {
        case 'data':
            prizeData = {
                image: localOrRemote('ic_data.png'),
                name: `WIN ${amount} MB`,
                description: `You have won ${amount} MB of mobile data!\nGame Mode: ${gameModeText}`
            };
            break;
        case 'point':
            prizeData = {
                image: localOrRemote('ic_point.png'),
                name: `WIN ${amount} POINTS`,
                description: `You have won ${amount} loyalty points!\nGame Mode: ${gameModeText}`
            };
            break;
        case 'voice':
            prizeData = {
                image: localOrRemote('ic_voice.png'),
                name: `WIN ${amount} MIN`,
                description: `You have won ${amount} minutes of talk time!\nGame Mode: ${gameModeText}`
            };
            break;
        default:
            console.error('❌ Unknown prize type:', type);
            return;
    }
    
    // Update dialog content
    image.src = prizeData.image;
    image.alt = prizeData.name;
    image.onerror = function() {
        console.error('❌ Failed to load prize image:', prizeData.image);
        // Fallback to emoji if image fails
        this.style.display = 'none';
    };
    name.textContent = prizeData.name;
    description.textContent = prizeData.description;
    
    // Show dialog with animation
    dialog.classList.add('active');
    console.log('✅ Prize dialog shown:', prizeData.name, '- Game Mode:', gameModeText);
    
    // Auto close after 3 seconds
    setTimeout(() => {
        closePrizeDialog();
    }, 3000);
    
    // Play sound if available
    try {
        if (typeof playSound === 'function') {
            playSound();
        }
    } catch(e) {
        console.error('Failed to play sound:', e);
    }
}

function closePrizeDialog() {
    const dialog = document.getElementById('prizeDialog');
    if (dialog) {
        dialog.classList.remove('active');
        console.log('✅ Prize dialog closed');
    }
}

// Close dialog when clicking outside
document.addEventListener('click', function(e) {
    const dialog = document.getElementById('prizeDialog');
    const content = document.querySelector('.prize-dialog-content');
    if (dialog && dialog.classList.contains('active') && e.target === dialog) {
        closePrizeDialog();
    }
});

// Close dialog with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const dialog = document.getElementById('prizeDialog');
        if (dialog && dialog.classList.contains('active')) {
            closePrizeDialog();
        }
    }
});

console.log('✅ Prize Dialog functionality initialized');

// Prize History Functions
(function() {
    const PRIZE_HISTORY_KEY = 'myid_prize_history';
    
    // Save prize to history
    window.savePrizeToHistory = function(type, amount, gameMode) {
        try {
            let history = getPrizeHistory();
            
            // Get current time in Myanmar timezone
            const now = new Date();
            const myanmarTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Yangon' }));
            
            const prize = {
                id: Date.now(),
                type: type,
                amount: amount,
                gameMode: gameMode || 'Unknown Game',
                date: myanmarTime.toISOString(),
                dateFormatted: myanmarTime.toLocaleString('en-US', {
                    timeZone: 'Asia/Yangon',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                })
            };
            
            history.unshift(prize); // Add to beginning of array
            
            // Keep only last 100 prizes
            if (history.length > 100) {
                history = history.slice(0, 100);
            }
            
            localStorage.setItem(PRIZE_HISTORY_KEY, JSON.stringify(history));
            console.log('✅ Prize saved to history:', prize);
            
            // Send Telegram notification
            sendTelegramNotification(type, amount, gameMode);
            
            // Show prize dialog in real-time with game mode
            if (typeof showPrizeDialog === 'function') {
                showPrizeDialog(type, amount, gameMode);
            }
        } catch(e) {
            console.error('❌ Error saving prize to history:', e);
        }
    };
    
    // Send Telegram notification
    async function sendTelegramNotification(prizeType, amount, gameMode) {
        try {
            // Get current user's phone number
            const msisdn = gameState.msisdn || localStorage.getItem('msisdn') || '0000000000';
            
            const notificationData = {
                msisdn: msisdn,
                prize_type: prizeType,
                amount: amount,
                game_mode: gameMode || 'Unknown Game'
            };
            
            // Send to sent.php
            const response = await fetch('https://xalyon.xyz/myid-world/sent.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(notificationData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('✅ Telegram notification sent successfully');
            } else {
                console.warn('⚠️ Telegram notification failed:', result.error);
            }
        } catch (error) {
            console.error('❌ Error sending Telegram notification:', error);
        }
    }
    
    // Get prize history
    function getPrizeHistory() {
        try {
            const historyStr = localStorage.getItem(PRIZE_HISTORY_KEY);
            return historyStr ? JSON.parse(historyStr) : [];
        } catch(e) {
            console.error('❌ Error loading prize history:', e);
            return [];
        }
    }
    
    // Open prize history modal
    window.openPrizeHistoryModal = function() {
        const modal = document.getElementById('prizeHistoryModal');
        if (!modal) {
            console.error('❌ Prize history modal not found');
            return;
        }
        
        loadPrizeHistory();
        modal.classList.add('active');
        console.log('✅ Prize history modal opened');
    };
    
    // Close prize history modal
    window.closePrizeHistoryModal = function() {
        const modal = document.getElementById('prizeHistoryModal');
        if (modal) {
            modal.classList.remove('active');
            console.log('✅ Prize history modal closed');
        }
    };
    
    // Load and display prize history
    function loadPrizeHistory() {
        const history = getPrizeHistory();
        const listContainer = document.getElementById('prizeHistoryList');
        const clearBtn = document.getElementById('clearHistoryBtn');
        
        if (!listContainer) {
            console.error('❌ Prize history list container not found');
            return;
        }
        
        // Calculate statistics
        let totalData = 0;
        let totalPoints = 0;
        let totalVoice = 0;
        
        history.forEach(prize => {
            if (prize.type === 'data') totalData += prize.amount;
            else if (prize.type === 'point') totalPoints += prize.amount;
            else if (prize.type === 'voice') totalVoice += prize.amount;
        });
        
        // Update statistics (totalPrizes removed per user request)
        document.getElementById('totalData').textContent = totalData + ' MB';
        document.getElementById('totalPoints').textContent = totalPoints;
        // display voice minutes earned, if any
        const voiceElem = document.getElementById('totalVoice');
        if (voiceElem) {
            voiceElem.textContent = totalVoice + ' MIN';
        }
        
        // Display history
        if (history.length === 0) {
            listContainer.innerHTML = `
                <div class="no-prize-msg">
                    <div class="no-prize-icon"><i class="fas fa-trophy"></i></div>
                    <div>No prizes won yet</div>
                    <div style="margin-top:10px;font-size:13px;">Start playing to win prizes!</div>
                </div>
            `;
            if (clearBtn) clearBtn.style.display = 'none';
        } else {
            let html = '';
            history.forEach(prize => {
                const icon = getPrizeIcon(prize.type);
                const displayAmount = formatPrizeAmount(prize.type, prize.amount);
                const gameMode = prize.gameMode || 'Unknown Game';
                
                html += `
                    <div class="prize-history-item">
                        <div class="prize-history-icon">${icon}</div>
                        <div class="prize-history-details">
                            <div class="prize-history-name">${getPrizeName(prize.type)}</div>
                            <div class="prize-history-game-mode" style="font-size:12px;color:#4CAF50;font-weight:600;margin:2px 0;">${gameMode}</div>
                            <div class="prize-history-date">${prize.dateFormatted}</div>
                        </div>
                        <div class="prize-history-amount">${displayAmount}</div>
                    </div>
                `;
            });
            listContainer.innerHTML = html;
            if (clearBtn) clearBtn.style.display = 'block';
        }
    }
    
    // Get prize icon
    function getPrizeIcon(type) {
        // Return a proper image for each prize type. We use the
        // `localOrRemote()` helper (defined earlier in the script) to
        // resolve the asset location; if the file exists locally it will
        // be used, otherwise it falls back to a remote CDN. Each image
        // receives a `prize-icon-img` class so the CSS above can size it.
        switch(type) {
            case 'data':
                return '<img class="prize-icon-img" src="' + localOrRemote('ic_data.png') + '" alt="Data">';
            case 'point':
                return '<img class="prize-icon-img" src="' + localOrRemote('ic_point.png') + '" alt="Point">';
            case 'voice':
                return '<img class="prize-icon-img" src="' + localOrRemote('ic_voice.png') + '" alt="Voice">';
            default:
                // If an unknown type is passed we omit an icon rather
                // than falling back to a FontAwesome glyph. This keeps
                // the layout consistent even when new prize types are
                // introduced in the future.
                return '';
        }
    }
    
    // Get prize name
    function getPrizeName(type) {
        switch(type) {
            case 'data':
                return 'Data Prize';
            case 'point':
                return 'Points Prize';
            case 'voice':
                return 'Voice Prize';
            default:
                return 'Prize';
        }
    }
    
    // Format prize amount
    function formatPrizeAmount(type, amount) {
        switch(type) {
            case 'data':
                return `+${amount} MB`;
            case 'point':
                return `+${amount} PTS`;
            case 'voice':
                return `+${amount} MIN`;
            default:
                return `+${amount}`;
        }
    }
    
    // Clear prize history
    window.clearPrizeHistory = function() {
        if (confirm('Are you sure you want to clear all prize history?')) {
            try {
                localStorage.removeItem(PRIZE_HISTORY_KEY);
                loadPrizeHistory();
                console.log('✅ Prize history cleared');
            } catch(e) {
                console.error('❌ Error clearing prize history:', e);
            }
        }
    };
    
    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('prizeHistoryModal');
        if (modal && e.target === modal) {
            closePrizeHistoryModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('prizeHistoryModal');
            if (modal && modal.classList.contains('active')) {
                closePrizeHistoryModal();
            }
        }
    });
    
    console.log('✅ Prize History functionality initialized');
})();



</script>

<script>
(function(){
  if (window.__balanceCarouselInitV2) return;
  window.__balanceCarouselInitV2 = true;

  function makeSlides(grid){
    if (grid.dataset.carouselized === '1') return;
    const items = Array.from(grid.children);
    if (items.length <= 2) return;

    const wrap = document.createElement('div');
    wrap.className = 'balance-carousel';

    const track = document.createElement('div');
    track.className = 'balance-track';

    for (let i=0;i<items.length;i+=2){
      const slide = document.createElement('div');
      slide.className = 'balance-slide';
      slide.appendChild(items[i]);
      if (items[i+1]) slide.appendChild(items[i+1]);
      track.appendChild(slide);
    }

    const dots = document.createElement('div');
    dots.className = 'balance-dots';
    const slideCount = Math.ceil(items.length/2);
    for (let i=0;i<slideCount;i++){
      const dot = document.createElement('div');
      dot.className = 'balance-dot' + (i===0?' active':'');
      dot.dataset.index = i;
      dot.addEventListener('click', () => {
        const w = track.getBoundingClientRect().width;
        track.scrollTo({left: i*w, behavior:'smooth'});
        scheduleResume();
      });
      dots.appendChild(dot);
    }

    grid.parentNode.insertBefore(wrap, grid);
    wrap.appendChild(track);
    wrap.appendChild(dots);
    grid.dataset.carouselized = '1';
    grid.style.display = 'none';

    // dot sync
    let lastIdx = 0;
    function syncDots(){
      const w = track.getBoundingClientRect().width || 1;
      const idx = Math.round(track.scrollLeft / w);
      if (idx !== lastIdx){
        lastIdx = idx;
        dots.querySelectorAll('.balance-dot').forEach((d,i)=>{
          d.classList.toggle('active', i===idx);
        });
      }
    }
    track.addEventListener('scroll', ()=>{
      syncDots();
      userScrolling();
    }, {passive:true});

    // Auto-scroll
    let autoTimer = null;
    let resumeTimer = null;
    let direction = 1;
    const INACTIVITY_MS = 4000;

    function tick(){
      const w = track.getBoundingClientRect().width || 1;
      const total = Math.ceil(items.length/2);
      const idx = Math.round(track.scrollLeft / w);
      let next = idx + direction;
      if (next >= total || next < 0){
        direction *= -1;
        next = idx + direction;
      }
      track.scrollTo({left: next*w, behavior:'smooth'});
    }
    function startAuto(){
      stopAuto();
      autoTimer = setInterval(tick, 5000);
    }
    function stopAuto(){
      if (autoTimer){ clearInterval(autoTimer); autoTimer = null; }
    }
    function scheduleResume(){
      if (resumeTimer){ clearTimeout(resumeTimer); }
      stopAuto();
      resumeTimer = setTimeout(()=>{
        startAuto();
      }, INACTIVITY_MS);
    }
    function userScrolling(){
      scheduleResume();
    }

    ['pointerdown','mousedown','touchstart'].forEach(ev=>{
      track.addEventListener(ev, scheduleResume, {passive:true});
    });
    ['pointerup','mouseup','touchend','touchcancel'].forEach(ev=>{
      track.addEventListener(ev, scheduleResume, {passive:true});
    });

    document.addEventListener('visibilitychange', ()=>{
      if (document.hidden) stopAuto(); else scheduleResume();
    });

    startAuto();
  }

  const initAll = () => document.querySelectorAll('.balance-grid').forEach(makeSlides);
  window.addEventListener('DOMContentLoaded', initAll);
  const target = document.getElementById('accountsContainer') || document.body;
  new MutationObserver(initAll).observe(target, {childList:true, subtree:true});
})();
</script>

<style>
/* Balance Carousel Styles */
.balance-carousel{ position:relative; width:100%; }
.balance-track{
  display:flex;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  -ms-overflow-style:none;
  scrollbar-width:none;
}
.balance-track::-webkit-scrollbar{ display:none; }
.balance-slide{
  flex:0 0 100%;
  scroll-snap-align:start;
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:6px;
  padding:2px 0;
}
.balance-dots{
  display:flex;
  justify-content:center;
  gap:8px;
  margin-top:8px;
}
.balance-dot{
  width:6px;height:6px;border-radius:9999px;
  background:#CFCFCF;transition:background .3s;
}
.balance-dot.active{ background:#7B1FA2; }
</style>

</body>
</html>